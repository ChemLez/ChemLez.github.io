<!DOCTYPE html>
<html>
<head hexo-theme='https://volantis.js.org/#'>
  <meta charset="utf-8">
  <!-- SEO相关 -->
  
    
  
  <!-- 渲染优化 -->
  <meta name="renderer" content="webkit">
  <meta name="force-rendering" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="HandheldFriendly" content="True" >
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <!-- 页面元数据 -->
  
    <title>Spring学习笔记(全) - Liz&#39;blog</title>
  
    <meta name="keywords" content="Spring">
  
  
    <meta name="description" content="0、基本介绍Spring是对业务层的操作,同时可以整合Mybatis框架和Spring MVC框架。下图是MVC结构：
">
  

  <!-- feed -->
  

  <!-- import meta -->
  

  <!-- link -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.12.1/css/all.min.css">
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css">

  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-waves@0.7.6/dist/waves.min.css">

  

  
  <link rel="shortcut icon" type='image/x-icon' href="https://s1.ax1x.com/2020/03/15/81ZR5F.jpg">
  

  

  <!-- import link -->
  

  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-volantis@2.1.5.2/css/style.css">

  

  <script>
    function setLoadingBarProgress(num) {
      document.getElementById('loading-bar').style.width=num+"%";
    }
  </script>

  
  
</head>

<body>
  
  <div id="loading-bar-wrapper">
  <div id="loading-bar"></div>
</div>
<header class="l_header shadow blur">

  <div class='wrapper'>
    <div class='nav-sub container--flex'>
      <a class="logo flat-box"></a>
      <ul class='switcher h-list'>
        <li><a class="s-comment flat-btn fas fa-comments fa-fw" target="_self" href='javascript:void(0)'></a></li>
        
          <li><a class="s-toc flat-btn fas fa-list fa-fw" target="_self" href='javascript:void(0)'></a></li>
        
      </ul>
    </div>
		<div class="nav-main container container--flex">
      
        
        <a class="logo flat-box" target="_self" href='/'>
          
          
          
          
            CHEMLEZ <b><sup style='color:#3AA757'></sup></b>
          
        </a>
      

			<div class='menu navigation'>
				<ul class='h-list'>
          
          
          
            
            
              <li>
                <a class="flat-box" href=/
                  
                  
                  
                    id="home"
                  >
                  
                    <i class='fas fa-home fa-fw'></i>
                  
                  主页
                </a>
                
              </li>
            
          
          
            
            
              <li>
                <a class="flat-box" 
                  
                  
                  >
                  
                    <i class='fas fa-list-alt fa-fw fa-fw'></i>
                  
                  索引
                </a>
                
                  <ul class="submenu">
                    
                      
            
              <li>
                <a class="flat-box" href=/tags/
                  
                  
                  
                    id="tags"
                  >
                  
                    <i class='fas fa-tags fa-fw'></i>
                  
                  标签
                </a>
                
              </li>
            
          
                    
                      
            
              <li>
                <a class="flat-box" href=/categories/
                  
                  
                  
                    id="categories"
                  >
                  
                    <i class='fas fa-folder-open fa-fw'></i>
                  
                  类别
                </a>
                
              </li>
            
          
                    
                      
            
              <li>
                <a class="flat-box" href=/archives/
                  
                  
                  
                    id="archives"
                  >
                  
                    <i class='fas fa-archive fa-fw'></i>
                  
                  归档
                </a>
                
              </li>
            
          
                    
                  </ul>
                
              </li>
            
          
          
            
            
              <li>
                <a class="flat-box" href=/friends/
                  
                  
                  
                    id="friends"
                  >
                  
                    <i class='fas fa-link fa-fw'></i>
                  
                  友链
                </a>
                
              </li>
            
          
          
            
            
              <li>
                <a class="flat-box" href=/about/
                  
                  
                  
                    id="about"
                  >
                  
                    <i class='fas fa-info-circle fa-fw'></i>
                  
                  关于
                </a>
                
              </li>
            
          
          
				</ul>
			</div>

      
        <div class="m_search">
          <form name="searchform" class="form u-search-form">
            <i class="icon fas fa-search fa-fw"></i>
            <input type="text" class="input u-search-input" placeholder="搜索" />
          </form>
        </div>
      

			<ul class='switcher h-list'>
				
					<li><a class="s-search flat-btn fas fa-search fa-fw" target="_self" href='javascript:void(0)'></a></li>
				
				<li><a class="s-menu flat-btn fas fa-bars fa-fw" target="_self" href='javascript:void(0)'></a></li>
			</ul>
		</div>
	</div>
</header>
<ul class="menu-phone navigation white-box">
  
  
    <li>
      <a class="flat-box" href=/
        
        
        
          id="home"
        >
        
          <i class='fas fa-clock fa-fw fa-fw'></i>
        
        近期文章
      </a>
    </li>
  
    <li>
      <a class="flat-box" href=/archives/
        
        
        
          id="archives"
        >
        
          <i class='fas fa-list-alt fa-fw fa-fw'></i>
        
        文章归档
      </a>
    </li>
  
    <li>
      <a class="flat-box" href=/categories/
        
        
        
          id="categories"
        >
        
          <i class='fas fa-folder-open fa-fw'></i>
        
        文章类别
      </a>
    </li>
  
    <li>
      <a class="flat-box" href=/tags/
        
        
        
          id="tags"
        >
        
          <i class='fas fa-tags fa-fw'></i>
        
        文章标签
      </a>
    </li>
  
    <li>
      <a class="flat-box" href=/friends/
        
        
        
          id="friends"
        >
        
          <i class='fas fa-link fa-fw'></i>
        
        我的友链
      </a>
    </li>
  
    <li>
      <a class="flat-box" href=/about/
        
        
        
          id="about"
        >
        
          <i class='fas fa-info-circle fa-fw'></i>
        
        关于小站
      </a>
    </li>
  
</ul>
<script>setLoadingBarProgress(40);</script>



  <div class="l_body nocover">
    <div class='body-wrapper'>
      

<div class='l_main'>
  

  
    <article id="post" class="post white-box shadow floatable article-type-post" itemscope itemprop="blogPost">
      


  <section class='meta'>
    
    
    <div class="meta" id="header-meta">
      
        
  
    <h1 class="title">
      <a href="/2020/09/22/Spring%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0(%E5%85%A8)/">
        Spring学习笔记(全)
      </a>
    </h1>
  


      
      <div class='new-meta-box'>
        
          
        
          
            
<div class='new-meta-item author'>
  <a href="https://chemlez.cn" target="_blank" rel="nofollow noopener">
    <img src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/placeholder/d570170f4f12e1ee829ca0e85a7dffeb77343a.svg" data-original="https://s1.ax1x.com/2020/03/13/8mvbCj.jpg">
    <p>Chemlez</p>
  </a>
</div>

          
        
          
            
  
  <div class='new-meta-item category'>
    <a href='/categories/Java/' rel="nofollow">
      <i class="fas fa-folder-open" aria-hidden="true"></i>
      <p>Java</p>
    </a>
  </div>


          
        
          
            <div class="new-meta-item date">
  <a class='notlink'>
    <i class="fas fa-edit" aria-hidden="true"></i>
    <p>发布于：Sep 22, 2020</p>
  </a>
</div>

          
        
          
            

          
        
      </div>
      
        <hr>
      
    </div>
  </section>


      <section class="article typo">
        <div class="article-entry" itemprop="articleBody">
          
          <h2 id="0、基本介绍"><a href="#0、基本介绍" class="headerlink" title="0、基本介绍"></a>0、基本介绍</h2><p><code>Spring</code>是对业务层的操作,同时可以整合<code>Mybatis</code>框架和<code>Spring MVC</code>框架。下图是<code>MVC</code>结构：</p>
<p><img src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/placeholder/d570170f4f12e1ee829ca0e85a7dffeb77343a.svg" data-original="https://s1.ax1x.com/2020/09/22/wXMKIS.png" alt=""></p>
<a id="more"></a>

<p><strong>耦合:</strong>简单理解为程序间的依赖关系</p>
<ul>
<li>类之间的依赖</li>
<li>方法间的依赖</li>
</ul>
<p><strong>解耦：</strong>降低程序间的依赖关系</p>
<p>实际开发中编译期不依赖，运行时才依赖。</p>
<p>解耦的思路：</p>
<p>第一步：使用反射来创建对象，而避免使用<code>new</code>关键字。</p>
<p>第二步：通过读取配置文件来获取要创建的对象全限定类名。</p>
<p>一个创建<code>Bean</code>对象的工厂。</p>
<p><code>Bean</code>:含有可重用组件的含义。</p>
<p><code>JavaBean</code>:用<code>Java</code>语言编写的可重用组件。</p>
<ul>
<li><code>JavaBean &gt; 实体类</code></li>
<li><code>JavaBean</code>就是创建<code>service</code>和<code>dao</code>对象的。</li>
</ul>
<p>第一个：需要一个配置文件来配置我们的<code>service</code>和<code>dao</code>配置的内容:唯一标识=全限定类名(<code>key=value</code>)</p>
<p>第二个：通过读取配置文件中配置的内容，反射创建对象。</p>
<p>配置文件可以是<code>xml</code>，也可以是<code>properties</code>。</p>
<p>使用步骤：</p>
<ol>
<li>创建<code>Properties</code>对象，读取配置文件。</li>
<li>通过类加载器读取流。</li>
</ol>
<p>以上两步通过<code>static</code>静态代码块加载。</p>
<p>加载文件代码块:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 模拟工厂进行解耦，一个创建Bean对象的工厂</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BeanFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//定义一个Properties对象</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Properties props;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//定义一个Map,用于存放我们要创建的对象。我们把它称之为容器</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String,Object&gt; beans;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//使用静态代码块为Properties对象赋值</span></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//实例化对象</span></span><br><span class="line">            props = <span class="keyword">new</span> Properties();</span><br><span class="line">            <span class="comment">//获取properties文件的流对象</span></span><br><span class="line">            InputStream in = BeanFactory.class.getClassLoader().getResourceAsStream("bean.properties");</span><br><span class="line">            props.load(in);</span><br><span class="line">            <span class="comment">//实例化容器</span></span><br><span class="line">            beans = <span class="keyword">new</span> HashMap&lt;String,Object&gt;();</span><br><span class="line">            <span class="comment">//取出配置文件中所有的Key</span></span><br><span class="line">            Enumeration keys = props.keys();</span><br><span class="line">            <span class="comment">//遍历枚举 -- 用来获取全限定类名的唯一标识符(key)</span></span><br><span class="line">            <span class="keyword">while</span> (keys.hasMoreElements())&#123;</span><br><span class="line">                <span class="comment">//取出每个Key</span></span><br><span class="line">                String key = keys.nextElement().toString();</span><br><span class="line">                <span class="comment">//根据key获取value -- 全限定类名</span></span><br><span class="line">                String beanPath = props.getProperty(key);</span><br><span class="line">                <span class="comment">//反射创建对象</span></span><br><span class="line">                Object value = Class.forName(beanPath).newInstance();</span><br><span class="line">                <span class="comment">//把key和value存入容器中</span></span><br><span class="line">                beans.put(key,value);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ExceptionInInitializerError(<span class="string">"初始化properties失败！"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据bean的名称获取对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> beanName</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">getBean</span><span class="params">(String beanName)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> beans.get(beanName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    private static Properties pro; //</span></span><br><span class="line"><span class="comment">//    private static Map&lt;String, Object&gt; beans;// 定义一个map，用于存放我们要创建的对象，将之称之为容器。</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//    static &#123;</span></span><br><span class="line"><span class="comment">//        try &#123;</span></span><br><span class="line"><span class="comment">//            pro = new Properties();</span></span><br><span class="line"><span class="comment">//            InputStream is = BeanFactory.class.getClassLoader().getResourceAsStream("bean.properties"); // 配置文件加载进内存</span></span><br><span class="line"><span class="comment">//            pro.load(is);</span></span><br><span class="line"><span class="comment">//            beans = new HashMap&lt;String, Object&gt;();</span></span><br><span class="line"><span class="comment">//            // 取出配置文件中的所有的key</span></span><br><span class="line"><span class="comment">//            Enumeration keys = pro.keys();</span></span><br><span class="line"><span class="comment">//            // 将全限定类名和反射创建的对象组成key-value，存放到集合中，这样我们对同一个类对象，就是只是从bean的集合中获取，始终获取的都是同一个对象。</span></span><br><span class="line"><span class="comment">//            while (keys.hasMoreElements()) &#123;</span></span><br><span class="line"><span class="comment">//                String key = keys.nextElement().toString();</span></span><br><span class="line"><span class="comment">//                String beanPath = pro.getProperty(key);</span></span><br><span class="line"><span class="comment">//                Object value = Class.forName(beanPath).newInstance();</span></span><br><span class="line"><span class="comment">//                beans.put(key, value);</span></span><br><span class="line"><span class="comment">//            &#125;</span></span><br><span class="line"><span class="comment">//        &#125; catch (IOException e) &#123;</span></span><br><span class="line"><span class="comment">//            e.printStackTrace();</span></span><br><span class="line"><span class="comment">//        &#125; catch (IllegalAccessException e) &#123;</span></span><br><span class="line"><span class="comment">//            e.printStackTrace();</span></span><br><span class="line"><span class="comment">//        &#125; catch (InstantiationException e) &#123;</span></span><br><span class="line"><span class="comment">//            e.printStackTrace();</span></span><br><span class="line"><span class="comment">//        &#125; catch (ClassNotFoundException e) &#123;</span></span><br><span class="line"><span class="comment">//            e.printStackTrace();</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//    /**</span></span><br><span class="line"><span class="comment">//     * 根据bean的名称获取对象</span></span><br><span class="line"><span class="comment">//     *</span></span><br><span class="line"><span class="comment">//     * @param beanName</span></span><br><span class="line"><span class="comment">//     * @return</span></span><br><span class="line"><span class="comment">//     */</span></span><br><span class="line"><span class="comment">//    public static Object getBean(String beanName) &#123;</span></span><br><span class="line"><span class="comment">//        Object bean = null; // 创建一个对象引用</span></span><br><span class="line"><span class="comment">//        bean = beans.get(beanName);</span></span><br><span class="line"><span class="comment">//        return bean;</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>单例对象：从始至终只有一个对象。</p>
<ul>
<li>只被创建一次，从而类中的成员也就只会初始化一次。</li>
</ul>
<p>多例对象：对象被创建多次，执行效率没有单例对象高。</p>
<p>目的：我们需要创建单例对象，只会初始化一次。</p>
<p>在创建工厂时，我们创建一个容器，将配置文件中的所有对象都提前创建好，存入到容器中，这样我们每次获取对象时，都是从这个容器中获取对象，保证我们始终获取的都是同一个对象。这里的容器就可以是<code>Map</code>集合。</p>
<ol>
<li>在<code>BeanFactory</code>中，以容器装载对象。 – 当获取对象时，是从容器中获取对象</li>
<li>获取对象，使用工厂获取对象，避免了<code>new</code>关键字创建出的对象，并由于工厂中，对象存储在容器中，保证了这里的对象的单例的。</li>
</ol>
<p>为了降低<code>Java</code>开发的复杂性，<code>Spring</code>采取了以下4种关键策略：</p>
<ul>
<li>基于<code>POJO</code>的轻量级和最小侵入性编程</li>
<li>通过依赖注入和面向接口实现松耦合</li>
<li>基于切面和惯例进行声明式编程</li>
<li>通过切面和模板减少样板式代码</li>
</ul>
<p><code>Spring</code>与很多框架不同的一个关键点在于：很多框继承通过强迫应用继承它们的类或实现它们的接口从而导致应用与框架绑死。而<code>Spring</code>不会强迫你实现<code>Spring</code>规范的接口或接口或继承<code>Spring</code>规范的类。</p>
<h2 id="一、IOC-–-控制反转"><a href="#一、IOC-–-控制反转" class="headerlink" title="一、IOC – 控制反转"></a>一、IOC – 控制反转</h2><p>将<code>new</code>的自主控制权交给了工厂。工厂再通过全限定类名决定得到获取到的对象。此时类无法再确定所获得到对象是否是自己所需要的(降低了耦合)。</p>
<p>使用步骤一:</p>
<ol>
<li><p>创建配置文件</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/beans/spring-beans.xsd"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 将对象的创建交给spring来管理 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"accountService"</span> <span class="attr">class</span>=<span class="string">"cn.lihzi.service.impl.AccountServiceImpl"</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"accountDao"</span> <span class="attr">class</span>=<span class="string">"cn.lihzi.dao.impl.AccountDaoImpl"</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>获取容器 – <code>spring</code>的核心容器，并根据<code>id</code>获取对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取spring的IOC核心容器，并根据id获取对象</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> args</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IllegalAccessException</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> InstantiationException</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> ClassNotFoundException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 1. 获取核心容器对象</span></span><br><span class="line">        ClassPathXmlApplicationContext ac = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">"bean.xml"</span>);</span><br><span class="line">        <span class="comment">// 2. 根据id获取Bean对象</span></span><br><span class="line">        AccountService service = (AccountService) ac.getBean(<span class="string">"accountService"</span>);</span><br><span class="line">        AccountDao dao = ac.getBean(<span class="string">"accountDao"</span>, AccountDao<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        System.out.println(service);</span><br><span class="line">        System.out.println(dao);</span><br><span class="line"><span class="comment">//        service.save();</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="1-1-ApplicationContext的三个常用实现类"><a href="#1-1-ApplicationContext的三个常用实现类" class="headerlink" title="1.1  ApplicationContext的三个常用实现类:"></a>1.1  ApplicationContext的三个常用实现类:</h3><ol>
<li><p><code>ClassPathXmlApplicationContext</code></p>
<p>它可以加载类路径下的配置文件，要求配置文件必须在类路径下。不在的话，加载不了。</p>
</li>
<li><p><code>FileSystemXmlApplicationContext</code></p>
<p>它可以加载磁盘任意路径下的配置文件(必须有访问权限)</p>
</li>
<li><p><code>AnnotationConfigApplicationContext</code></p>
<p>它用于读取注解创建的容器</p>
</li>
</ol>
<h3 id="1-2-核心容器的两个接口引发出的问题"><a href="#1-2-核心容器的两个接口引发出的问题" class="headerlink" title="1.2 核心容器的两个接口引发出的问题"></a>1.2 核心容器的两个接口引发出的问题</h3><ol>
<li><p><code>ApplicationContext</code></p>
<p>它在构建核心容器时，创建对象采取的策略是采用立即加载的方法。也就是说，只要一读取完配置文件马上就创建配置文件中配置的对象。</p>
<p>试用情况:单例对象适用，更多采用此接口</p>
</li>
<li><p><code>BeanFactory</code></p>
<p>它在构建核心容器时，创建对象采取的策略是采用延迟加载的方式。也就是说，什么时候根据<code>id</code>获取对象，什么时候才是真正的创建对象。</p>
<p>试用情况:多例对象适用。</p>
</li>
</ol>
<h3 id="1-3-Bean对象的细节"><a href="#1-3-Bean对象的细节" class="headerlink" title="1.3 Bean对象的细节"></a>1.3 Bean对象的细节</h3><ol>
<li>创建<code>Bean</code>的三种方式:</li>
</ol>
<ul>
<li>第一种方式</li>
</ul>
<p>使用默认构造函数创建。<br>在<code>spring</code>的配置文件中使用bean标签，配以<code>id</code>和<code>class</code>属性之后，且没有其他属性和标签时。<br>采用的就是默认构造函数创建bean对象，此时如果类中没有默认构造函数，则对象无法创建。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"accountService"</span> <span class="attr">class</span>=<span class="string">"cn.lihzi.service.impl.AccountServiceImpl"</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"accountDao"</span> <span class="attr">class</span>=<span class="string">"cn.lihzi.dao.impl.AccountDaoImpl"</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>第二种方式</li>
</ul>
<p>使用工厂中的普通方法创建对象(使用某个类中的方法创建对象，并存入spring容器)</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"instanceFactory"</span> <span class="attr">class</span>=<span class="string">"cn.lihzi.factory.InstanceFactory"</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"accountService"</span> <span class="attr">factory-bean</span>=<span class="string">"instanceFactory"</span> <span class="attr">factory-method</span>=<span class="string">"getAccountService"</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>通过<code>factory-bean</code>找到<code>id</code>得到其对象，再通过<code>factory-method</code>得到其方法对象。而其中的<code>id=&quot;accountService&quot;</code>是对应到容器中的<code>key</code>。</p>
<ul>
<li>第三种方式</li>
</ul>
<p>使用工厂中的静态方法创建对象(使用某个类中的静态方法创建对象，并存入spring容器)。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"accountService"</span> <span class="attr">class</span>=<span class="string">"cn.lihzi.factory.StaticInstanceFactory"</span> <span class="attr">factory-method</span>=<span class="string">"getAccountService"</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>其中，第二种、第三种方式可以用来获取到<code>jar</code>包中的方法对象。</p>
<ol start="2">
<li><code>Bean</code>的作用范围</li>
</ol>
<p>默认的作用范围是<strong>单例</strong>。</p>
<p><code>bean</code>标签的<code>scope</code>属性：</p>
<p>作用：用于指定<code>bean</code>的作用范围</p>
<p>取值：常用的就是单例的和多例的</p>
<ul>
<li><code>singleto</code>：单例的(默认值)</li>
<li><code>prototype</code>：多例的</li>
<li><code>request</code>：作用于<code>web</code>应用的请求范围</li>
<li><code>session</code>：作用于<code>web</code>应用的会话范围</li>
<li><code>global-session</code>：作用于集群环境的会话范围(全局会话范围)，当不会集群环境时，它就是<code>session</code></li>
</ul>
<ol start="3">
<li><code>bean</code>对象的生命周期</li>
</ol>
<ul>
<li><p>单例对象</p>
<p>出生：当容器创建时对象出生</p>
<p>活着：只要容器还在，对象一直活着</p>
<p>死亡：容器销毁，对象消亡</p>
<p>总结：单例对象的生命周期和容器相同</p>
</li>
<li><p>多例对象</p>
<p>出生：当我们使用对象时<code>spring</code>框架为我们创建</p>
<p>活着：对象只要是在使用过程中就一直活着</p>
<p>死亡：当对象长时间不用，且没有别的对象引用时，由<code>Java</code>的垃圾回收器回收</p>
</li>
</ul>
<p><code>bean</code>配置文件中分别是，<code>init-method</code>；<code>destory-method</code>指定初始化和销毁时使用的对象方法。</p>
<blockquote>
<p>注：创建应用组件之间协作的行为通常称为装配(wiring)。Spring有多种装配bean的方式，采用<code>XML</code>是很常见的一种装配方式。</p>
</blockquote>
<p><code>Spring</code>通过应用上下文(Application Context)装载<code>Bean</code>的定义并把它们组装起来。<code>Spring</code>应用上下文全权负责对象的创建和组装。<code>Spring</code>自带了多种应用上下文的实现，它们之间主要的区别仅仅在于如何加载配置。</p>
<h3 id="1-4-Spring的依赖注入"><a href="#1-4-Spring的依赖注入" class="headerlink" title="1.4 Spring的依赖注入"></a>1.4 Spring的依赖注入</h3><p>依赖注入： <code>Dependency Injection</code>。<strong>依赖注入会将所依赖的关系自动交给目标对象，而不是让对象自己去获取依赖。</strong>通过<code>DI</code>,对象的依赖关系将由系统中负责协调各对象的第三方组件(就是容器)在创建对象的时候进行设定，对象无需自行创建或管理它们的依赖关系，依赖关系将被自动注入到需要它们的对象当中去。</p>
<p>在进行测试时，可以使用<code>Mock</code>测试。所谓的Mock测试就是指在测试过程中，模拟出那些不容易获取或者不容易构造出来的对象，比如HttpServletRequest对象需要在Servlet容器中构造出来。</p>
<p>使用<code>mock</code>框架Mockito去创建一个<code>Quest</code>接口的<code>mock</code>实现，通过该<code>mock</code>就可以创建新的所属实例，并通过构造器注入这个<code>mock</code>创建出的实例对象。（即通过构造器注入，来达到松耦合）</p>
<p><code>IOC</code>作用:降低程序间的耦合(依赖关系)</p>
<p>依赖关系的管理</p>
<ul>
<li>交给<code>spring</code>来维护</li>
</ul>
<p>在当前类需要用到其他类的对象，由<code>spring</code>为我们提供，我们只需要在配置文件中说明</p>
<p>依赖关系的维护就称之为依赖注入。</p>
<p>依赖注入：</p>
<ul>
<li>能注入的数据：三类<ul>
<li>基本数据类型和<code>String</code></li>
<li>其他<code>bean</code>类型(在配置文件中或者注解配置过的<code>bean</code>)</li>
<li>复杂类型/集合类型</li>
</ul>
</li>
<li>注入的方式：三种<ul>
<li>使用构造函数提供</li>
<li>使用<code>set</code>方法提供</li>
<li>使用注解提供</li>
</ul>
</li>
</ul>
<h4 id="1-4-1-构造函数注入（构造器注入）"><a href="#1-4-1-构造函数注入（构造器注入）" class="headerlink" title="1.4.1 构造函数注入（构造器注入）"></a>1.4.1 构造函数注入（构造器注入）</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 构造函数注入：</span></span><br><span class="line"><span class="comment">    使用的标签:constructor-arg</span></span><br><span class="line"><span class="comment">    标签出现的位置：bean标签的内部</span></span><br><span class="line"><span class="comment">    标签中的属性</span></span><br><span class="line"><span class="comment">        type:用于指定要注入的数据的数据类型，该数据类型也是构造函数中某个或某些参数的类型(当构造函数中同时含有多个相同的数据类型时，就无法分别)</span></span><br><span class="line"><span class="comment">        index:用于指定要注入的数据给构造函数中指定索引位置的参数赋值。索引的位置是从0开始</span></span><br><span class="line"><span class="comment">        name:用于指定给构造函数中指定名称的参数赋值。(最常用，也是最直接的方式)</span></span><br><span class="line"><span class="comment">        =============以上三个用于指定给构造函数中哪个参数赋值================</span></span><br><span class="line"><span class="comment">        value:用于提供基本类型和String类型的数据</span></span><br><span class="line"><span class="comment">        ref:用于指定其他的bean类型数据。它指的就是在spring的Ioc核心容器中出现过的bean对象。</span></span><br><span class="line"><span class="comment">    特点：</span></span><br><span class="line"><span class="comment">        在获取bean对象时，注入数据是必须的操作，否则对象无法创建成功。</span></span><br><span class="line"><span class="comment">    缺点：</span></span><br><span class="line"><span class="comment">        改变了bean对象的实例化方法，使我们在创建对象时，如果用不到这些数据，也必须提供。</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br></pre></td></tr></table></figure>

<p>类的代码:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AccountServiceImpl</span> <span class="keyword">implements</span> <span class="title">AccountService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">    <span class="keyword">private</span> Date birthday;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AccountServiceImpl</span><span class="params">(String name, Integer age, Date birthday)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">        <span class="keyword">this</span>.birthday = birthday;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">save</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"service方法执行.."</span>+name+<span class="string">":"</span>+age+<span class="string">":"</span>+birthday);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>配置文件：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"accountService"</span> <span class="attr">class</span>=<span class="string">"cn.lihzi.service.impl.AccountServiceImpl"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">name</span>=<span class="string">"name"</span> <span class="attr">value</span>=<span class="string">"Tom"</span>&gt;</span><span class="tag">&lt;/<span class="name">constructor-arg</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">name</span>=<span class="string">"age"</span> <span class="attr">value</span>=<span class="string">"18"</span>&gt;</span><span class="tag">&lt;/<span class="name">constructor-arg</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">name</span>=<span class="string">"birthday"</span> <span class="attr">ref</span>=<span class="string">"now"</span>&gt;</span><span class="tag">&lt;/<span class="name">constructor-arg</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 以下是配置一个日期对象 反射方式创建Date的对象，再由id指定赋值--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"now"</span> <span class="attr">class</span>=<span class="string">"java.util.Date"</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="1-4-2-set方法注入-–-适用于存在空参的构造方法-更常用的set方法注入"><a href="#1-4-2-set方法注入-–-适用于存在空参的构造方法-更常用的set方法注入" class="headerlink" title="1.4.2 set方法注入 – 适用于存在空参的构造方法(更常用的set方法注入)"></a>1.4.2 set方法注入 – 适用于存在空参的构造方法(更常用的set方法注入)</h4><p>涉及的标签：<code>property</code></p>
<p>出现的位置：<code>bean</code>标签的内部</p>
<p>标签的属性</p>
<ul>
<li><code>name</code>：用于指定注入时所调用的<code>set</code>方法名称</li>
<li><code>value</code>：用于提供基本类型和<code>String</code>类型的数据</li>
<li><code>ref</code>：用于指定其他的<code>bean</code>类型数据。它指的就是在<code>spring</code>的<code>Ioc</code>核心容器中出现的<code>bean</code>对象。</li>
</ul>
<p>优势:</p>
<ul>
<li>创建对象时没有明确的限制，可以直接使用默认构造函数</li>
</ul>
<p>弊端：</p>
<ul>
<li>如果有某个成员必须有值，则获取对象是有可能<code>set</code>方法没有执行。</li>
</ul>
<p>配置文件:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">&lt;!-- set --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"accountService1"</span> <span class="attr">class</span>=<span class="string">"cn.lihzi.service.impl.AccountServiceImpl1"</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"age"</span> <span class="attr">value</span>=<span class="string">"18"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"name"</span> <span class="attr">value</span>=<span class="string">"Tom"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--       &lt;property name="birthday" ref="now"&gt;&lt;/property&gt;--&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="1-4-3-复杂类型的注入-集合类型的注入"><a href="#1-4-3-复杂类型的注入-集合类型的注入" class="headerlink" title="1.4.3 复杂类型的注入/集合类型的注入"></a>1.4.3 复杂类型的注入/集合类型的注入</h4><p>用于给<code>List</code>结构集合注入的标签：<code>list</code>、<code>array</code>、<code>set</code></p>
<p>用于给<code>Map</code>结构集合注入的标签：<code>map</code>、<code>props</code></p>
<p>结构相同，标签可以互换。</p>
<p>实体类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AccountServiceImpl2</span> <span class="keyword">implements</span> <span class="title">AccountService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, String&gt; map;</span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; list;</span><br><span class="line">    <span class="keyword">private</span> Set&lt;String&gt; set;</span><br><span class="line">    <span class="keyword">private</span> Properties properties;</span><br><span class="line">    <span class="keyword">private</span> String[] str;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">		省略了getter和setter方法</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">save</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"str:"</span>+Arrays.toString(str));</span><br><span class="line">        System.out.println(<span class="string">"map:"</span>+map);</span><br><span class="line">        System.out.println(<span class="string">"list:"</span>+list);</span><br><span class="line">        System.out.println(<span class="string">"set:"</span>+set);</span><br><span class="line">        System.out.println(<span class="string">"properties:"</span>+properties);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>Bean</code>配置文件:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">&lt;!-- 复杂对象的封装使用 --&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"accountService2"</span> <span class="attr">class</span>=<span class="string">"cn.lihzi.service.impl.AccountServiceImpl2"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"list"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>a<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>b<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>c<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"str"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>a<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>b<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>c<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"set"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>a<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>b<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>c<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"map"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">map</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">"name"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">value</span>&gt;</span>Tom<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">"age"</span> <span class="attr">value</span>=<span class="string">"18"</span>&gt;</span><span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">map</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"properties"</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--            &lt;map&gt;--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--                &lt;entry key="name"&gt;--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--                    &lt;value&gt;Tom&lt;/value&gt;--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--                &lt;/entry&gt;--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--                &lt;entry key="age" value="18"&gt;&lt;/entry&gt;--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--                --&gt;</span></span><br><span class="line"><span class="comment">&lt;!--            &lt;/map&gt;--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">props</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">"name"</span>&gt;</span>Tom<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">"age"</span>&gt;</span>18<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">props</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="二、基于注解的方式-–-IOC"><a href="#二、基于注解的方式-–-IOC" class="headerlink" title="二、基于注解的方式 – IOC"></a>二、基于注解的方式 – IOC</h2><p><code>xml</code>起始的配置</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"accountService"</span> <span class="attr">class</span>=<span class="string">"cn.lihzi.service.impl.AccountServiceImpl"</span> <span class="attr">scope</span>=<span class="string">""</span> <span class="attr">init-method</span>=<span class="string">""</span> <span class="attr">destory-method</span>=<span class="string">""</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">""</span> <span class="attr">value</span>=<span class="string">""</span> <span class="attr">ref</span>=<span class="string">""</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>注解类别：</p>
<ol>
<li><p>用于创建对象的(创建的对象存放至<code>Spring</code>容器中)</p>
<ul>
<li><p>其作用就和在<code>XML</code>配置文件中编写一个<code>&lt;bean&gt;</code>标签实现的功能是一样的</p>
</li>
<li><p><code>@Component</code></p>
</li>
</ul>
</li>
<li><p>作用：用于把当前类对象写入<code>spring</code>容器中。</p>
</li>
<li><p>属性：</p>
<pre><code>- `value`：用于指定`bean`的`id`。当我们不写时，它的默认值是当前类名，且首字母小写。</code></pre></li>
</ol>
<ul>
<li><p><code>@Controller</code>：一般用于表现层</p>
</li>
<li><p><code>@Service</code>：一般用在业务层</p>
</li>
<li><p><code>@Respository</code>：一般用于持久层</p>
</li>
</ul>
<p>以上三个注解他们的作用和属性与<code>Component</code>是一模一样的。</p>
<p>他们三个是<code>Spring</code>框架为我们提供明确的三层使用的注解，使我们的三层对象更加清晰。</p>
<ol start="2">
<li><p>用于注入数据的(注入的对象是从<code>Spring</code>容器中获取)</p>
<ul>
<li>其作用就和在<code>xml</code>配置文件中的<code>bean</code>标签中写一个<code>&lt;property&gt;</code>标签的作用是一样的</li>
<li><code>@Autowired</code><ul>
<li>作用：自动按照类型注入。只要容器中有唯一的一个<code>bean</code>对象类型和要注入的变量类型匹配，就可以注入成功。</li>
<li>出现位置：可以是变量上，也可以是方法上。</li>
<li>细节：在使用注解注入时，<code>set</code>方法就不是必须的了。</li>
<li>如果<code>IOC</code>容器中有多个类型匹配时:先找到同类别的，再根据变量名称进行注入。</li>
</ul>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/placeholder/d570170f4f12e1ee829ca0e85a7dffeb77343a.svg" data-original="https://s1.ax1x.com/2020/09/22/wXMQPg.md.png" alt="自动注入流程"></p>
<p>通过在<code>Spring</code>容器中符合数据类型的<code>value</code>，并将<code>value</code>值赋给该引用，当出现同类型的引用时，再根据变量名称进行赋值。</p>
<ul>
<li><code>@Qualifier</code><ul>
<li>作用：在按照类中注入的基础之上再按照名称注入。它在给类成员注入时不能单独使用。但是在给方法参数注入时可以。（要和<code>@Autowired</code>配合使用）</li>
<li>属性<ul>
<li><code>value</code>：用于指定注入<code>bean</code>的<code>id</code>。</li>
</ul>
</li>
</ul>
</li>
<li><code>@Resource</code><ul>
<li>作用：直接按照<code>bean</code>的<code>id</code>注入。它可以独立使用。</li>
<li>属性<ul>
<li><code>name</code>：用于指定<code>bean</code>的<code>id</code>。</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>以上三个注入都只能注入其他<code>bean</code>类型的数据，而基本类型和<code>String</code>类型无法使用上述注解实现。</p>
<p>另外集合只能通过<code>xml</code>来实现。</p>
<ul>
<li><code>@Value</code><ul>
<li>作用:用于注入基本类型和<code>String</code>类型的数据。</li>
<li>属性:<ul>
<li><code>value</code>：用于指定数据的值。它可以使用<code>spring</code>中<code>SpEL</code>(也就是<code>spring</code>的<code>el</code>表达式)</li>
<li><code>SpEL</code>的写法：<code>${表达式}</code>。注意：其表达式写在哪里(<code>JSP</code>、<code>Mybatis</code>、<code>Spring</code>…)，就是从哪里获值。</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>用于改变作用范围的</p>
<ul>
<li>其作用就和在<code>bean</code>标签中使用<code>scope</code>属性实现的功能是一样的</li>
<li><code>@Scope</code><ul>
<li>作用:用于指定<code>bean</code>的作用范围</li>
<li>属性:<ul>
<li><code>value</code>：指定范围的取值。常用取值：<code>singleton</code>、<code>prototype</code>(默认为<code>singleton</code>)</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>生命周期相关</p>
<ul>
<li>其作用就和在<code>bean</code>标签中使用<code>init-method</code>和<code>destory-method</code>的作用是一样的。</li>
<li><code>@PreDestroy</code><ul>
<li>作用：用于指定销毁方法</li>
</ul>
</li>
<li><code>@PostConstruct</code><ul>
<li>作用：用于指定初始化方法</li>
</ul>
</li>
</ul>
</li>
</ol>
<p><strong>注意：</strong>需要告知<code>spring</code>在创建容器时要扫描的包、配置所需要的标签不是在<code>bean</code>的约束中，而是一个名称为<code>context</code>名称空间和约束中。其配置文件形式为：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">"http://www.springframework.org/schema/context"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/context</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/context/spring-context.xsd"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:annotation-config</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">"cn.lihzi"</span>&gt;</span><span class="tag">&lt;/<span class="name">context:component-scan</span>&gt;</span> <span class="comment">&lt;!-- 扫描这个包下的所有包及其子包 --&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="2-1-实例：简单的数据库增删改查"><a href="#2-1-实例：简单的数据库增删改查" class="headerlink" title="2.1 实例：简单的数据库增删改查"></a>2.1 实例：简单的数据库增删改查</h3><ol>
<li><code>XML</code>方式</li>
</ol>
<p><code>service</code>层中，提供<code>setter</code>方法，共<code>xml</code>配置使用。</p>
<p>配置:</p>
<ul>
<li>业务层对象</li>
<li>持久层对象</li>
<li><code>JDBC</code>对象</li>
<li>数据库连接池</li>
</ul>
<p>注意数据源的单例、多例造成的线程混乱问题</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/beans/spring-beans.xsd"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 创建service对象，并将service对象中的变量注入数据dao --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"accountService"</span> <span class="attr">class</span>=<span class="string">"cn.lizhi.service.impl.AccountServiceImpl"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dao"</span> <span class="attr">ref</span>=<span class="string">"accountDao"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 创建dao对象，并给变量注入数据,runner --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"accountDao"</span> <span class="attr">class</span>=<span class="string">"cn.lizhi.dao.impl.AccountDaoImpl"</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 注入runner --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"runner"</span> <span class="attr">ref</span>=<span class="string">"queryRunner"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 创建QueryRunner对象 并采用构造方法的方式，注入数据源(这里采用的是有参构造方法，其参数就是dataSource数据源，故进而再创建dataSource对象) --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- QueryRunner对象，是单例对象。为了让多个dao在调用这个对象时，互不干扰，故采取多例的方法 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"queryRunner"</span> <span class="attr">class</span>=<span class="string">"org.apache.commons.dbutils.QueryRunner"</span> <span class="attr">scope</span>=<span class="string">"prototype"</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 注入数据源，方便sql语句的复用，不用每次都传入数据 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">name</span>=<span class="string">"ds"</span> <span class="attr">ref</span>=<span class="string">"dataSource"</span>&gt;</span><span class="tag">&lt;/<span class="name">constructor-arg</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 配置数据源dataSource，给dataSource对象的变量注入数据--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"dataSource"</span> <span class="attr">class</span>=<span class="string">"com.mchange.v2.c3p0.ComboPooledDataSource"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"driverClass"</span> <span class="attr">value</span>=<span class="string">"com.mysql.jdbc.Driver"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"jdbcUrl"</span> <span class="attr">value</span>=<span class="string">"jdbc:mysql://url:3306/draft"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"user"</span> <span class="attr">value</span>=<span class="string">"username"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"password"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>测试方法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AccountServiceTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1. 获取对象</span></span><br><span class="line">    <span class="keyword">private</span> ApplicationContext ac = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">"bean.xml"</span>);</span><br><span class="line">    <span class="comment">// 2. 得到业务层对象</span></span><br><span class="line">    <span class="keyword">private</span> AccountService service = ac.getBean(<span class="string">"accountService"</span>, AccountService<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">findAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        List&lt;Account&gt; accounts = service.findAll();</span><br><span class="line">        <span class="keyword">for</span> (Account account : accounts) &#123;</span><br><span class="line">            System.out.println(account);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">findById</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Account account = service.findById(<span class="number">1</span>);</span><br><span class="line">        System.out.println(account);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insert</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Account account = <span class="keyword">new</span> Account();</span><br><span class="line">        account.setName(<span class="string">"Tom"</span>);</span><br><span class="line">        account.setMoney(<span class="number">800.8f</span>);</span><br><span class="line">        service.insert(account);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>基于注解的<code>IOC</code>配置</li>
</ol>
<p><strong>注意一点</strong>：当用注解方式对变量进行注入时，<code>setter</code>方法就不是必要的了。</p>
<p><code>xml</code>配置文件：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">"http://www.springframework.org/schema/context"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/context</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/context/spring-context.xsd"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">"cn.lizhi"</span>&gt;</span><span class="tag">&lt;/<span class="name">context:component-scan</span>&gt;</span> <span class="comment">&lt;!-- 扫描这个包下的所有包及其子包 --&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- service和dao的对象通过注解的方法创建以及注入--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"queryRunner"</span> <span class="attr">class</span>=<span class="string">"org.apache.commons.dbutils.QueryRunner"</span> <span class="attr">scope</span>=<span class="string">"prototype"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">name</span>=<span class="string">"ds"</span> <span class="attr">ref</span>=<span class="string">"dataSource"</span>&gt;</span><span class="tag">&lt;/<span class="name">constructor-arg</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"dataSource"</span> <span class="attr">class</span>=<span class="string">"com.mchange.v2.c3p0.ComboPooledDataSource"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"driverClass"</span> <span class="attr">value</span>=<span class="string">"com.mysql.jdbc.Driver"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"jdbcUrl"</span> <span class="attr">value</span>=<span class="string">"jdbc:mysql://url/draft"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"user"</span> <span class="attr">value</span>=<span class="string">"username"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"password"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="2-2-使用注解不带有xml配置文件的使用-纯注解"><a href="#2-2-使用注解不带有xml配置文件的使用-纯注解" class="headerlink" title="2.2 使用注解不带有xml配置文件的使用(纯注解)"></a>2.2 使用注解不带有<code>xml</code>配置文件的使用(纯注解)</h3><ol>
<li><p>创建配置类 — <code>config</code></p>
<p>例如：<code>SpringConfiguration</code>：其作用同<code>bean.xml</code>相同</p>
<p><code>spring</code>中的新注解：</p>
<ol>
<li><p><code>@Configuration</code></p>
<ul>
<li>作用:指定当前类是一个配置类</li>
</ul>
</li>
</ol>
<ul>
<li>细节:当配置类作为<code>AnnotationConfigApplicationContext</code>对象创建的参数时，该注解可以不写。(原因是参数传递的是配置的<code>Class</code>对象，就能够读取到这个类)</li>
</ul>
</li>
<li><p><code>@ComponentScan</code></p>
<ul>
<li><p>作用:用于通过注解指定<code>spring</code>在创建容器时要扫描的包</p>
</li>
<li><p>属性：</p>
<ul>
<li><p><code>value</code>：它和<code>basePackages</code>的作用是一样的，都是用于指定创建容器时要扫描的包。我们使用此注解就等同于在<code>xml</code>中配置了：</p>
<p><code>&lt;context:component-scan base-package=&quot;cn.lizhi&quot;&gt;&lt;/context:component-scan&gt;</code></p>
</li>
</ul>
</li>
</ul>
</li>
<li><p><code>@Bean</code></p>
<ul>
<li><p>作用：用于把当前方法的<strong>返回值</strong>作为<code>bean</code>对象存入<code>spring</code>的<code>ioc</code>容器中</p>
<ul>
<li><p>属性：</p>
<ul>
<li><code>name</code>：用于指定<code>bean</code>的<code>id</code>。当不写时，默认值是当前方法的名称</li>
</ul>
</li>
<li><p>细节：</p>
<p>当我们使用注解配置方法时，如果方法需要传递参数，<code>Spring</code>框架会去容器中查找有没有可用的对应类型的<code>bean</code>对象。查找的方式和<code>Autowired</code>注解的作用是一样的。</p>
</li>
</ul>
</li>
</ul>
</li>
<li><p><code>@Import</code></p>
<ul>
<li>作用:用于导入其他的配置类</li>
<li>属性<ul>
<li><code>value</code>:用于指定其他配置类的字节码。当我们使用<code>import</code>的注解之后，有<code>Import</code>注解的类就是父配置类，而导入的都是子配置类。</li>
</ul>
</li>
</ul>
</li>
</ol>
<p>在主配置类下配置<code>@import</code>，<code>@import</code>中的参数为<code>value</code>数组，内容填写子配置类。这样也可以不用在子配置类下配置<code>@Configuration</code>注解。</p>
<ol start="5">
<li><p><code>@PropertySource</code></p>
<ul>
<li>作用：用于指定<code>properties</code>文件的位置。</li>
<li>属性：<ul>
<li><code>value</code>：指定文件的名称和路径。</li>
<li>关键字：<code>classpath</code>，表示类路径下。<ul>
<li>例如:<code>@PropertySource(classpath:jdbcConfig.properties)</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<p>注解位置在主配置文件下。</p>
<p><code>xml</code>和注解配置选择问题:自己写的类，选择采用<code>注解</code>的方式；存在于<code>jar</code>包中的选择用<code>xml</code>方式，两者可以配合着使用。</p>
<p>注解类:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan</span>(<span class="string">"cn.lizhi"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">     <span class="meta">@Bean</span>(<span class="string">"runner"</span>) <span class="comment">// 用于将返回值存入容器中 -- 其中id设置为runner</span></span><br><span class="line">     <span class="meta">@Scope</span>(<span class="string">"prototype"</span>) <span class="comment">// 将数据源设置成多例</span></span><br><span class="line">     <span class="function"><span class="keyword">public</span> QueryRunner <span class="title">getRunner</span><span class="params">(DataSource dataSource)</span> </span>&#123; <span class="comment">// 获取QueryRunner对象 -- 参数为dataSource,故进一步再得到dataSource对象，见下方</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> QueryRunner(dataSource);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span>(<span class="string">"dataSource"</span>) -- 容器中id为dataSource</span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">getDataSource</span><span class="params">()</span> </span>&#123; </span><br><span class="line">        ComboPooledDataSource cpds = <span class="keyword">new</span> ComboPooledDataSource();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            cpds.setDriverClass(<span class="string">"com.mysql.jdbc.Driver"</span>);</span><br><span class="line">            cpds.setJdbcUrl(<span class="string">"jdbc:mysql://url:3306/draft"</span>);</span><br><span class="line">            cpds.setUser(<span class="string">"username"</span>);</span><br><span class="line">            cpds.setPassword(<span class="string">"password"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (PropertyVetoException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> cpds;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试用例:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AccountServiceTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1. 获取对象</span></span><br><span class="line"><span class="comment">//    private ApplicationContext ac = new ClassPathXmlApplicationContext("bean.xml");</span></span><br><span class="line">    <span class="keyword">private</span> ApplicationContext ac = <span class="keyword">new</span> AnnotationConfigApplicationContext(SpringConfiguration<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    <span class="comment">// 2. 得到业务层对象</span></span><br><span class="line">    <span class="keyword">private</span> AccountService service = ac.getBean(<span class="string">"accountService"</span>, AccountService<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">findAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        List&lt;Account&gt; accounts = service.findAll();</span><br><span class="line">        <span class="keyword">for</span> (Account account : accounts) &#123;</span><br><span class="line">            System.out.println(account);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">findById</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Account account = service.findById(<span class="number">1</span>);</span><br><span class="line">        System.out.println(account);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insert</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Account account = <span class="keyword">new</span> Account();</span><br><span class="line">        account.setName(<span class="string">"Tom"</span>);</span><br><span class="line">        account.setMoney(<span class="number">800.8f</span>);</span><br><span class="line">        service.insert(account);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Account account = service.findById(<span class="number">4</span>);</span><br><span class="line">        account.setMoney(<span class="number">1000.0f</span>);</span><br><span class="line">        service.update(account,account.getId());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">delete</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        service.delete(<span class="number">4</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意:</strong>此时接口的实现方法使用的是<code>AnnotationConfigApplicationContext</code>。</p>
</li>
<li><p>抽取子配置类</p>
<ol>
<li><p><code>JdbcConfig</code> - 子配置类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JdbcConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;jdbc.driver&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String driver;</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;jdbc.url&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String url;</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;jdbc.user&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String user;</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;jdbc.password&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span>(<span class="string">"runner"</span>)</span><br><span class="line">    <span class="meta">@Scope</span>(<span class="string">"prototype"</span>) <span class="comment">// 将数据源设置成多例</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> QueryRunner <span class="title">getRunner</span><span class="params">(DataSource dataSource)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> QueryRunner(dataSource);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span>(<span class="string">"dataSource"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">getDataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ComboPooledDataSource cpds = <span class="keyword">new</span> ComboPooledDataSource();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            cpds.setDriverClass(driver);</span><br><span class="line">            cpds.setJdbcUrl(url);</span><br><span class="line">            cpds.setUser(user);</span><br><span class="line">            cpds.setPassword(password);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (PropertyVetoException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> cpds;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>SpringConfiguration</code> - 父配置类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Import</span>(JdbcConfig<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line">@ComponentScan("cn.lizhi")</span><br><span class="line"><span class="meta">@PropertySource</span>(<span class="string">"classpath:jdbcConfig.properties"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringConfiguration</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>jdbcConfig.properties</code> - 配置文件</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">jdbc.driver</span>=<span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line"><span class="meta">jdbc.url</span>=<span class="string">jdbc:mysql://url:3306/draft</span></span><br><span class="line"><span class="meta">jdbc.user</span>=<span class="string">username</span></span><br><span class="line"><span class="meta">jdbc.password</span>=<span class="string">password</span></span><br></pre></td></tr></table></figure>

</li>
</ol>
</li>
</ol>
<h3 id="2-3-spring整合junit问题"><a href="#2-3-spring整合junit问题" class="headerlink" title="2.3 spring整合junit问题"></a>2.3 spring整合junit问题</h3><p>整合原因：</p>
<blockquote>
<ol>
<li>应用程序的入口 – main 方法</li>
<li><code>junit</code>单元测试中，没有<code>main</code>方法也能执行<ul>
<li><code>junit</code>集成了一个<code>main</code>方法</li>
<li>该方法就会判断当前测试类中哪些方法有<code>@Test</code>注解</li>
<li><code>junit</code>就让有<code>Test</code>注解的方法执行</li>
</ul>
</li>
<li><code>junit</code>中无法探测出是否存在<code>spring</code>框架<ul>
<li>在执行测试方法时，<code>junit</code>无法得知我们是否使用了<code>spring</code>框架</li>
<li>因此也就不会为我们读取配置文件/配置类创建<code>spring</code>核心容器</li>
</ul>
</li>
</ol>
<p>综上：在执行测试方式时，没有<code>IOC</code>容器，就算谢了<code>Autowired</code>注解，也无法实现注入</p>
</blockquote>
<p><code>Spring</code>整合<code>junit</code>的配置</p>
<ol>
<li><p>导入<code>spring</code>整合<code>junit</code>的<code>jar</code>(坐标)</p>
</li>
<li><p>使用<code>junit</code>提供的一个注解把原有的<code>main</code>方法替换了，替换成<code>spring</code>提供的 <code>@RunWith</code>注解配置–<code>SpringJUnit4ClassRunner.class</code></p>
</li>
<li><p>告知<code>spring</code>的运行器，<code>spring</code>和<code>ioc</code>创建是基于<code>xml</code>还是基于<code>注解</code>的，并且说明位置。</p>
<ul>
<li><p><code>@ContextConfiguration</code></p>
<ul>
<li><p><code>locations</code>:指定<code>xml</code>文件的位置，加上<code>classpath</code>关键字，表示在类路径下。</p>
</li>
<li><p><code>classes</code>:指定注解所在地位置。å例如：<code>@ContextConfiguration(classes=SpringConfiguration.class)</code></p>
</li>
</ul>
<p>当我们使用<code>spring 5.x</code>版本的时候，要求<code>junit</code>的<code>jar</code>包必须是<code>4.12</code>以上。</p>
</li>
</ul>
</li>
</ol>
<h2 id="三、AOP-–-导读"><a href="#三、AOP-–-导读" class="headerlink" title="三、AOP – 导读"></a>三、AOP – 导读</h2><p><code>AOP</code>允许将遍布应用各处的功能分离出来形成可重用的组件。即通过AOP，<strong>可以使用各种功能层去包裹核心业务层</strong>。这些层以声明的方式灵活地应用到系统中，核心应用甚至根本不知道它们的存在，即将安全、事务和日志关注点与核心业务逻辑相分离。</p>
<h3 id="3-1-案例-transfer-银行转账案例"><a href="#3-1-案例-transfer-银行转账案例" class="headerlink" title="3.1 案例-transfer(银行转账案例)"></a>3.1 案例-transfer(银行转账案例)</h3><p>在<code>service</code>接口中定义转账方法(其参数列表为转出用户,转入用户,转账金额)，<code>dao</code>接口中定义根据用户名称查找用户的方法。</p>
<p>当在数据库数据进行更新时(转账过程中)，如果出现异常，可能就会出现破坏数据库的一致性操作。故下面要进行对事物的控制。</p>
<p>事务控制在<code>service</code>层。</p>
<p><img src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/placeholder/d570170f4f12e1ee829ca0e85a7dffeb77343a.svg" data-original="https://s1.ax1x.com/2020/09/22/wXMnVf.png" alt="事务控制"></p>
<p>以上的问题引发了一个思考，就是获取的<code>connection</code>应该全部由同一个<code>connection</code>进行控制，要成功就一起成功，如果失败就一起失败。</p>
<p><strong>解决办法:</strong>需要使用<code>ThreadLocal</code>对象把<code>Connection</code>与当前线程绑定，从而使一个线程中只有一个能控制事务的对象。</p>
<p><strong>事务控制应该都是在业务层。</strong></p>
<p>注意：在<code>web</code>工程中，当<code>tomcat</code>服务器启动时，会初始化线程池，当我们对<code>tomcat</code>服务器进行访问时，便会从线程池中获取线程，同时当使用数据库连接池时，在获取连接以后，当我们对线程访问完毕以后，需要对线程进行归还，此时归还到线程池中的线程还在绑定着数据库的连接，所以在归还连接(线程)前(无论是线程或数据库连接),都需要将线程与数据库连接进行解绑，否则当我们再获取这个线程时，因为它绑定着数据库连接池中的那个连接，再使用时是无法使用的，因为这个数据连接已经被<code>close</code>(归还)了，需要我们重新获取连接并进行绑定。</p>
<p>通过创建<code>service</code>的代理对象的工厂解决事务上方法的耦合问题。即对<code>service</code>类中的方法进行增强(增强的内容就是加入事务的控制)。</p>
<p>事务解决的整个思路：</p>
<ol>
<li><p>创建<code>ConnectionUtils</code>工具类，通过<code>ThreadLocal</code>绑定数据库连接。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 线程绑定</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConnectionUtils</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ThreadLocal&lt;Connection&gt; tl = <span class="keyword">new</span> ThreadLocal&lt;Connection&gt;(); <span class="comment">// 绑定的对象 -- Connection</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> DataSource dataSource; <span class="comment">// 获取数据源</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDataSource</span><span class="params">(DataSource dataSource)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.dataSource = dataSource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Connection <span class="title">getThreadConnection</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        Connection conn = tl.get();</span><br><span class="line">        <span class="keyword">if</span> (conn == <span class="keyword">null</span>) &#123; <span class="comment">// 如果TreadLocal未绑定有连接，则从连接池中获取连接，并对其进行绑定</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                conn = dataSource.getConnection();</span><br><span class="line">                tl.set(conn);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> conn;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 对其进行解绑</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Connection conn = tl.get();</span><br><span class="line">        <span class="keyword">if</span> (conn != <span class="keyword">null</span>) &#123;</span><br><span class="line">            tl.remove();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建事务管理类，用于在业务层对<code>SQL</code>进行事务管理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 对事物进行管理的工具类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransactionManager</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ConnectionUtils connectionUtils;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setConnectionUtils</span><span class="params">(ConnectionUtils connectionUtils)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.connectionUtils = connectionUtils;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 开启事务</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">beginTransaction</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            connectionUtils.getThreadConnection().setAutoCommit(<span class="keyword">false</span>); <span class="comment">// 关闭自动提交 -- 即使用此方法为开启事务(关闭了自动提交事务)</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 提交事务</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">commit</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            connectionUtils.getThreadConnection().commit();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 回滚事务</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rollback</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            connectionUtils.getThreadConnection().rollback();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 释放连接</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">release</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            connectionUtils.getThreadConnection().close();</span><br><span class="line">            connectionUtils.remove(); <span class="comment">// 释放连接时，将线程与数据库连接池中的连接进行解绑</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>dao</code>层代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AccountDaoImpl</span> <span class="keyword">implements</span> <span class="title">AccountDao</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// 通过spring配置获取QueryRunner对象</span></span><br><span class="line">    <span class="keyword">private</span> QueryRunner runner;</span><br><span class="line">    <span class="comment">// 通过spring配置获取连接</span></span><br><span class="line">    <span class="keyword">private</span> ConnectionUtils connectionUtils;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setConnectionUtils</span><span class="params">(ConnectionUtils connectionUtils)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.connectionUtils = connectionUtils;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setRunner</span><span class="params">(QueryRunner runner)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.runner = runner;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">(Account account, Integer id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            runner.update(connectionUtils.getThreadConnection(), <span class="string">"update account set name=?,money=? where id=?"</span>, account.getName(), account.getMoney(), id);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Account <span class="title">findByName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        Account account = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            List&lt;Account&gt; accounts = runner.query( <span class="string">"select * from account where name=?"</span>, <span class="keyword">new</span> BeanListHandler&lt;Account&gt;(Account<span class="class">.<span class="keyword">class</span>), <span class="title">name</span>)</span>;</span><br><span class="line">            <span class="keyword">if</span> (accounts == <span class="keyword">null</span> || accounts.size() == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"该用户不存在"</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (accounts.size() &gt; <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"用户存在异常，存在两个异常"</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                account = accounts.get(<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> account;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><code>connectionUtils.getThreadConnection()</code>用于获取连接。</p>
</li>
<li><p>创建工厂类-用于创建<code>service</code>的代理对象的工厂</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BeanFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> AccountService accountService;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> TransactionManager tsManager;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">setTsManager</span><span class="params">(TransactionManager tsManager)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.tsManager = tsManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAccountService</span><span class="params">(AccountService accountService)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.accountService = accountService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取代理对象，对方法进行增强</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span>  AccountService <span class="title">getAccountService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        AccountService proxy_accountService = (AccountService) Proxy.newProxyInstance(accountService.getClass().getClassLoader(), accountService.getClass().getInterfaces(), <span class="keyword">new</span> InvocationHandler() &#123;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 增强对事务的控制</span></span><br><span class="line"><span class="comment">            **/</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">                Object obj = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// 1. 开启事务</span></span><br><span class="line">                    tsManager.beginTransaction();</span><br><span class="line">                    <span class="comment">// 2. 执行语句</span></span><br><span class="line">                    obj = method.invoke(accountService, args);</span><br><span class="line">                    <span class="comment">// 3. 提交事务</span></span><br><span class="line">                    tsManager.commit();</span><br><span class="line">                    <span class="keyword">return</span> obj;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    <span class="comment">// 4. 回滚事务</span></span><br><span class="line">                    tsManager.rollback();</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="comment">// 5. 关闭连接</span></span><br><span class="line">                    tsManager.release();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> proxy_accountService;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里被代理的对象为<code>accountService</code>，当我们使用它的方法时，我们其实是在使用其代理对象(通过<code>BeanFactory</code>中<code>getAccountService</code>方法创建出的对象)中增强后的方法。其中，创建工厂中普通方法的配置方法:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 创建工厂类对象 --&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"beanFactory"</span> <span class="attr">class</span>=<span class="string">"cn.lizhi.factory.BeanFactory"</span>&gt;</span></span><br><span class="line">       <span class="comment">&lt;!-- 被代理对象 --&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"accountService"</span> <span class="attr">ref</span>=<span class="string">"accountService"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">       <span class="comment">&lt;!-- 注入事务管理器 --&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"tsManager"</span> <span class="attr">ref</span>=<span class="string">"transaction"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">   <span class="comment">&lt;!-- 创建工厂类方法对象 --&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"proxyAccountService"</span> <span class="attr">factory-bean</span>=<span class="string">"beanFactory"</span> <span class="attr">factory-method</span>=<span class="string">"getAccountService"</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>例如被代理对象(<code>AccountService</code>)中的一处方法为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transfer</span><span class="params">(String startName, String endName, Float money)</span> </span>&#123;</span><br><span class="line">   </span><br><span class="line">    Account startAccount = dao.findByName(startName); <span class="comment">// 出款人账号 -- 会获取连接</span></span><br><span class="line">    Account endAccount = dao.findByName(endName); <span class="comment">// 收款人账号 -- 会获取连接</span></span><br><span class="line">    Float startMoney = startAccount.getMoney();</span><br><span class="line">    startAccount.setMoney(startMoney - money);</span><br><span class="line">    Float endMoney = endAccount.getMoney();</span><br><span class="line">    endAccount.setMoney(endMoney + money);</span><br><span class="line">    dao.update(startAccount, startAccount.getId()); <span class="comment">// 会获取连接</span></span><br><span class="line">    <span class="keyword">int</span> a = <span class="number">3</span> / <span class="number">0</span>;</span><br><span class="line">    dao.update(endAccount, endAccount.getId()); <span class="comment">// 会获取连接</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>即通过代理对象增强后，对其方法进行了事务管理，即对以下方法的执行，在其上下添加事务的管理。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">obj = method.invoke(accountService, args);</span><br></pre></td></tr></table></figure>

<p>增强的方法等价于：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transfer</span><span class="params">(String startName, String endName, Float money)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 1. 开启事务</span></span><br><span class="line">        tsManager.beginTransaction();</span><br><span class="line">        <span class="comment">// 2. 执行操作</span></span><br><span class="line">        Account startAccount = dao.findByName(startName); <span class="comment">// 出款人账号 -- 会获取连接</span></span><br><span class="line">        Account endAccount = dao.findByName(endName); <span class="comment">// 收款人账号 -- 会获取连接</span></span><br><span class="line">        Float startMoney = startAccount.getMoney();</span><br><span class="line">        startAccount.setMoney(startMoney - money);</span><br><span class="line">        Float endMoney = endAccount.getMoney();</span><br><span class="line">        endAccount.setMoney(endMoney + money);</span><br><span class="line">        dao.update(startAccount, startAccount.getId()); <span class="comment">// 会获取连接</span></span><br><span class="line">        <span class="keyword">int</span> a = <span class="number">3</span> / <span class="number">0</span>;</span><br><span class="line">        dao.update(endAccount, endAccount.getId()); <span class="comment">// 会获取连接</span></span><br><span class="line">        <span class="comment">// 3. 提交事务</span></span><br><span class="line">        tsManager.commit();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="comment">// 4. 回滚事务</span></span><br><span class="line">        tsManager.rollback();</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// 5. 关闭连接</span></span><br><span class="line">        tsManager.release();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由以上的比较，故能够很清晰的看到，通过动态代理的方法，可以简化代码量以及降低方法间的耦合问题。</p>
<p>如果，采用上面一般的方式，即在业务层中所有的方法都要加入事务管理的相关代码，这样就增加了代码的冗余；其次，如果我们对<code>TransactionManager</code>类中关于事务管理的方法名进行修改，那么在业务层中相应调用事务的方法名也都要修改。</p>
<p>如果，采用动态代理的方式：</p>
<ol>
<li>我们关于事务管理的代码只需要写一次(工厂类中的代理对象)。</li>
<li><code>TransactionManage</code>类中事务管理相关的方法名修改后，只需要在代理对象中对增强的方法进行修改即可。</li>
</ol>
</li>
<li><p>最后依赖注入的对象是代理对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="meta">@Qualifier</span>(<span class="string">"proxyAccountService"</span>)</span><br><span class="line"><span class="keyword">private</span> AccountService service = <span class="keyword">null</span>;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h2 id="四、Spring-AOP"><a href="#四、Spring-AOP" class="headerlink" title="四、Spring AOP"></a>四、Spring AOP</h2><h3 id="4-1-AOP基本介绍"><a href="#4-1-AOP基本介绍" class="headerlink" title="4.1 AOP基本介绍"></a>4.1 AOP基本介绍</h3><p><strong>定义：</strong></p>
<blockquote>
<p>在软件业，AOP为Aspect Oriented Programming的缩写，意为：<a href="https://baike.baidu.com/item/面向切面编程/6016335" target="_blank" rel="noopener">面向切面编程</a>，通过<a href="https://baike.baidu.com/item/预编译/3191547" target="_blank" rel="noopener">预编译</a>方式和运行期间动态代理实现程序功能的统一维护的一种技术。AOP是<a href="https://baike.baidu.com/item/OOP" target="_blank" rel="noopener">OOP</a>的延续，是软件开发中的一个热点，也是<a href="https://baike.baidu.com/item/Spring" target="_blank" rel="noopener">Spring</a>框架中的一个重要内容，是<a href="https://baike.baidu.com/item/函数式编程/4035031" target="_blank" rel="noopener">函数式编程</a>的一种衍生范型。利用AOP可以对业务逻辑的各个部分进行隔离，从而使得业务逻辑各部分之间的<a href="https://baike.baidu.com/item/耦合度/2603938" target="_blank" rel="noopener">耦合度</a>降低，提高程序的可重用性，同时提高了开发的效率。</p>
</blockquote>
<p><strong>作用：</strong></p>
<ul>
<li>在程序运行期间，不修改源码对已有方法进行增强。</li>
</ul>
<p><strong>优势:</strong></p>
<ul>
<li>减少重复代码</li>
<li>提高开发效率</li>
<li>维护方便</li>
</ul>
<p><strong>实现方式:</strong></p>
<ul>
<li>使用动态代理技术</li>
</ul>
<h3 id="4-2-Spring中的AOP介绍"><a href="#4-2-Spring中的AOP介绍" class="headerlink" title="4.2 Spring中的AOP介绍"></a>4.2 Spring中的AOP介绍</h3><h4 id="4-2-1-AOP相关术语介绍及使用介绍"><a href="#4-2-1-AOP相关术语介绍及使用介绍" class="headerlink" title="4.2.1 AOP相关术语介绍及使用介绍"></a>4.2.1 AOP相关术语介绍及使用介绍</h4><ol>
<li><p><code>Joinpoint(连接点)</code></p>
<p>所谓连接点是指那些被拦截的点。在<code>Spring</code>中，这些点指的是方法，因为<code>Spring</code>只支持方法类型的连接点。即：在业务逻辑中的全部方法。</p>
</li>
<li><p><code>Pointcut(切入点)</code></p>
<p>所谓切入点是指我们要对哪些<code>Joinpoint</code>进行拦截的定义。即：在业务逻辑中，那些被增强的方法。所以，有些方法是连接点，但不是切入点，因为没有被增强。</p>
<p>所以得出：所有的切入点都是连接点，但并不一定所有的连接点都是切入点。(只有被增强的连接点，才是切入点)</p>
</li>
<li><p><code>Advice(通知/增强)</code></p>
<p>所谓通知，是指拦截到<code>Joinpoint</code>之后所要做的事情就是通知。(即，想要增加的功能，事先定义好，然后在想要用的地方添加通知即可)</p>
<p>通知的类型：</p>
<ul>
<li>前置通知：在<code>method.invoke()</code>之前执行的方法</li>
<li>后置通知：在<code>method.invoke()</code>之后执行的方法</li>
<li>异常通知：<code>catch</code>中的代码</li>
<li>最终通知：<code>finally</code>中的代码</li>
<li>环绕通知：整个<code>invoke</code>(<code>public Object invoke..</code>)方法在执行就是环绕通知，即在环绕通知中有明确的切入点方法调用。 – 最强大的一个通知</li>
</ul>
</li>
<li><p><code>Introduction(引介)</code></p>
<p>引介是一种特殊的通知在不修改类代码的前提下，<code>Introduction</code>可以在运行期为类动态地添加一些方法或<code>Field</code>。</p>
</li>
<li><p><code>Target(目标对象)</code></p>
<p>代理的目标对象。(被代理对象)</p>
</li>
<li><p><code>Weaving(织入)</code></p>
<p>是指把增强应用到目标对象来创建新的代理对象的过程。</p>
<p><code>Spring</code>采用动态代理织入，而<code>AspectJ</code>采用编译期织入和类装载期织入。</p>
</li>
<li><p><code>Proxy(代理)</code></p>
<p>一个类被<code>AOP</code>织入增强后，就产生一个结果代理类。</p>
</li>
<li><p><code>Aspect(切面)</code></p>
<p>是切入点和通知(引介)的结合。</p>
</li>
</ol>
<p><code>Spring</code>框架监控切入点方法的执行。一旦监控到切入点方法被运行，使用代理机制，动态创建目标对象的代理对象，根据通知类型，在代理对象的对应位置，将通知对应的功能织入，完成完整的代码逻辑运行。   </p>
<p>将公共代码作为通知(即把通知<code>Bean</code>交给<code>Spring</code>来管理)，由<code>AOP</code>配置织入到切入点。</p>
<p><code>Logger</code>类作为通知:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 模拟记录日志的工具类,里面提供了公共的代码</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Logger</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用于打印日志，计划让其在切入点方法执行之前执行(这里切入点方法就是业务层方法)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">printLog</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"记录了日志..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以<code>Logger</code>类为例，<code>aop</code>相关配置步骤:</p>
<ol>
<li><p>配置<code>Spring</code>的<code>IOC</code>,把<code>service</code>对象配置进来。</p>
</li>
<li><p><code>spring</code>中基于<code>XML</code>的<code>aop</code>配置步骤：</p>
<ol>
<li><p>把通知<code>Bean</code>交给<code>spring</code>来管理</p>
</li>
<li><p>使用<code>aop:config</code>标签表明开始<code>AOP</code>的配置</p>
</li>
<li><p>使用<code>aop:aspect</code>标签表明配置切面</p>
<ul>
<li><code>id</code>属性：是给切面提供一个唯一的标识</li>
<li><code>ref</code>属性：是指定通知类<code>bean</code>的<code>Id</code></li>
</ul>
</li>
<li><p>在<code>aop:aspect</code>标签的内部使用对应标签来配置通知的类型</p>
<p>在<code>Logger</code>类中的<code>pringLog</code>方法是在切入点方法执行之前，所以是前置通知</p>
<p><code>aop:before</code> 表示配置前置通知</p>
<ul>
<li><code>method</code>属性：用于指定<code>Logger</code>类中哪个方法是前置通知。</li>
<li><code>pointcut</code>属性：用于指定切入点表达式，该表达式的含义是对业务层中哪些方法增强</li>
</ul>
<p>切入点表达式的写法：</p>
<ul>
<li><p>关键字：<code>execution(表达式)</code></p>
</li>
<li><p>表达式：</p>
<p><code>访问修饰符  返回值  包名.包名.包名...类名.方法名(参数列表)</code></p>
</li>
</ul>
</li>
</ol>
</li>
</ol>
<p>根据以上说明，见下方配置：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:aop</span>=<span class="string">"http://www.springframework.org/schema/aop"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/aop</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/aop/spring-aop.xsd"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 配置Spring的IOC,把Service对象配置进来 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"accountService"</span> <span class="attr">class</span>=<span class="string">"cn.lizhi.service.impl.AccountServiceImpl"</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 配置Logger类(通知) --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"logger"</span> <span class="attr">class</span>=<span class="string">"cn.lizhi.utlis.Logger"</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 配置AOP --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">aop:config</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 配置切面 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">aop:aspect</span> <span class="attr">id</span>=<span class="string">"logAdvice"</span> <span class="attr">ref</span>=<span class="string">"logger"</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 配置通知的类型，并且建立通知方法和切入点方法的关联--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">aop:before</span> <span class="attr">method</span>=<span class="string">"printLog"</span> <span class="attr">pointcut</span>=<span class="string">"execution(public void cn.lizhi.service.impl.AccountServiceImpl.saveAccount())"</span>&gt;</span><span class="tag">&lt;/<span class="name">aop:before</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">aop:aspect</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">aop:config</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li><p>切入点表达式的写法</p>
<ol>
<li><p>全通配写法</p>
<p><code>* *..*.*(..)</code></p>
<p>原因:</p>
<ul>
<li><p>访问修饰符可以省略</p>
<p><code>void cn.lizhi.service.impl.AccountServiceImpl.saveAccount()</code></p>
</li>
<li><p>返回值可以改成任意类型的返回值</p>
<p><code>* cn.lizhi.service.impl.AccountServiceImpl.saveAccount()</code></p>
</li>
<li><p>包名可以使用通配符，表示任意包。但是有几级包，就需要几个<code>*.</code></p>
<p><code>* *.*.*.*.AccountServiceImpl.saveAccount()</code></p>
</li>
<li><p>包名可以使用<code>..</code>表示当前包及其子包</p>
<p><code>* *..AccountServiceImpl.saveAccount()</code></p>
</li>
<li><p>类名和方法名都可以使用<code>*</code>来实现通配</p>
<p><code>* *..*.*()</code></p>
</li>
<li><p>参数列表：</p>
<ol>
<li><p>可以直接写数据类型：</p>
<ul>
<li>基本类型直接写名称 例如:<code>int</code></li>
<li>引用类型写包名.类名的方式 例如：<code>java.lang.String</code></li>
</ul>
</li>
<li><p>可以使用通配符表示任意类型，但是必须有参数</p>
</li>
<li><p>可以使用<code>..</code>表示有无参数均可，有参数可以是任意类型</p>
<p><code>* *..*.*(..)</code></p>
</li>
</ol>
</li>
</ul>
<p>实际开发中切入点表达式的通常写法：</p>
<ul>
<li><p>切到业务层实现类下的所有方法</p>
<p><code>* cn.lizhi.service.impl.*.*(..)</code></p>
</li>
</ul>
<p>总结：以上是正则表达式的应用,正则表达式中<code>*</code>代表0次或无限次扩展；<code>.</code>代表任何单个字符。</p>
</li>
</ol>
</li>
</ol>
<h4 id="4-1-2-四种常用通知类型"><a href="#4-1-2-四种常用通知类型" class="headerlink" title="4.1.2 四种常用通知类型"></a>4.1.2 四种常用通知类型</h4><ul>
<li>前置通知：在切入点方法执行之前执行，类比动态代理中的<code>method.invoke</code>执行之前的开启事务方法 – <code>before</code></li>
<li>后置通知：在切入点方法正常执行之后执行。它和异常通知永远只能执行一个，类比事务中的<code>commit</code> – <code>after-returning</code></li>
<li>异常通知：在切入点方法执行产生异常之后执行。它和后置通知永远只能执行一个，类比<code>catch</code>代码块中的<code>rollback</code>。– <code>after-throwing</code></li>
<li>最终通知：无论切入点方法是否正常执行，它都会在其后面执行,类比<code>finally</code>代码块。 – <code>after</code></li>
</ul>
<p>最终配置文件：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:aop</span>=<span class="string">"http://www.springframework.org/schema/aop"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/aop</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/aop/spring-aop.xsd"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 配置Spring的IOC,把Service对象配置进来 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"accountService"</span> <span class="attr">class</span>=<span class="string">"cn.lizhi.service.impl.AccountServiceImpl"</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 配置Logger类(通知) --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"logger"</span> <span class="attr">class</span>=<span class="string">"cn.lizhi.utlis.Logger"</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 配置AOP --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">aop:config</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">aop:pointcut</span> <span class="attr">id</span>=<span class="string">"pt1"</span> <span class="attr">expression</span>=<span class="string">"execution(* cn.lizhi.service.impl.*.*(..))"</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 配置切面 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">aop:aspect</span> <span class="attr">id</span>=<span class="string">"logAdvice"</span> <span class="attr">ref</span>=<span class="string">"logger"</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 配置通知的类型，并且建立通知方法和切入点方法的关联--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">aop:before</span> <span class="attr">method</span>=<span class="string">"beforePrintLog"</span> <span class="attr">pointcut-ref</span>=<span class="string">"pt1"</span>&gt;</span><span class="tag">&lt;/<span class="name">aop:before</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">aop:after-returning</span> <span class="attr">method</span>=<span class="string">"afterReturningPrintLog"</span> <span class="attr">pointcut-ref</span>=<span class="string">"pt1"</span>&gt;</span><span class="tag">&lt;/<span class="name">aop:after-returning</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">aop:after-throwing</span> <span class="attr">method</span>=<span class="string">"afterThrowingPrintLog"</span> <span class="attr">pointcut-ref</span>=<span class="string">"pt1"</span>&gt;</span><span class="tag">&lt;/<span class="name">aop:after-throwing</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">aop:after</span> <span class="attr">method</span>=<span class="string">"afterPrintLog"</span> <span class="attr">pointcut-ref</span>=<span class="string">"pt1"</span>&gt;</span><span class="tag">&lt;/<span class="name">aop:after</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">aop:aspect</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">aop:config</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>其中这个切入点表达式的配置</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">aop:pointcut</span> <span class="attr">id</span>=<span class="string">"pt1"</span> <span class="attr">expression</span>=<span class="string">"execution(* cn.lizhi.service.impl.*.*(..))"</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>id</code>属性用于指定表达式的唯一标识。</p>
<p><code>expression</code>属性用于指定表达式内容。</p>
<p>同时，此标签写在<code>aop:aspect</code>标签内部只能当前切面使用。</p>
<p>当它写在<code>aop:aspect</code>外面时，此时就变成了所有切面可用。</p>
<p>步骤：</p>
<ol>
<li>把需要切入的对象，声明一个<code>bean</code></li>
<li>在<code>&lt;aop:aspect&gt;</code>元素中引用该<code>bean</code>，为了进一步定义切面</li>
<li>声明<code>&lt;aop:before&gt;</code>等标签，即声明前置通知、后置通知</li>
<li><code>pointcut-ref</code>属性都引用了名字为<code>pt1</code>的切入点。该切入点是在前边的<code>&lt;pointcut&gt;</code>元素中定义的，并配置<code>expression</code>属性来选择所应用的通知。</li>
</ol>
<p>通过少量的<code>XML</code>配置，就可以把<code>logger</code>声明为一个切面。</p>
<p>这样做的好处是，<code>logger</code>类仍然是一个<code>POJO</code>，代码没有任何的更改，但通过以上的修改，<code>logger</code>可以作为一个切面进行使用了；同时，最重要的是，被切入的对象完全不知道<code>Logger</code>的存在。（注意：需要使用的切面，仍然先需要定义成一个<code>bean</code>)</p>
<h4 id="4-1-3-环绕通知"><a href="#4-1-3-环绕通知" class="headerlink" title="4.1.3 环绕通知"></a>4.1.3 环绕通知</h4><h5 id="4-1-3-1-问题"><a href="#4-1-3-1-问题" class="headerlink" title="4.1.3.1 问题"></a>4.1.3.1 问题</h5><p>当我们配置了环绕通知之后，切入点方法没有执行，而通知方法执行了。</p>
<h5 id="4-1-3-2-分析"><a href="#4-1-3-2-分析" class="headerlink" title="4.1.3.2 分析"></a>4.1.3.2 分析</h5><p>通过对比动态代理中的环绕通知代码，发现动态代理的环绕通知有明确的切入点方法调用，而我们的代码代码中没有。</p>
<h5 id="4-1-3-3-解决"><a href="#4-1-3-3-解决" class="headerlink" title="4.1.3.3 解决"></a>4.1.3.3 解决</h5><p><code>Spring</code>框架为我们提供了一个接口：<code>ProceedingJoinPoint</code>。该接口有一个方法<code>proceed()</code>，此方法就相当于明确调用切入点方法。</p>
<p>该接口可以作为环绕通知的方法参数，在程序执行时，<strong><code>spring</code>框架会为我们提供该接口的实现类供我们使用</strong>。</p>
<p>使用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">aroundPrintLog</span><span class="params">(ProceedingJoinPoint pjp)</span> </span>&#123;</span><br><span class="line">    Object obj = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">"Logger类中aroundPrintLog方法开始记录日志了...前置"</span>); <span class="comment">// 前置通知</span></span><br><span class="line">        Object[] args = pjp.getArgs(); <span class="comment">// 得到方法执行所需要的参数</span></span><br><span class="line">        obj = pjp.proceed(args);<span class="comment">// 明确调用业务层方法(切入点方法)</span></span><br><span class="line">        System.out.println(<span class="string">"Logger类中aroundPrintLog方法开始记录日志了...后置"</span>); <span class="comment">// 后置通知</span></span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable throwable) &#123;</span><br><span class="line">        System.out.println(<span class="string">"Logger类中aroundPrintLog方法开始记录日志了...异常"</span>); <span class="comment">// 异常通知</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(throwable);</span><br><span class="line">    &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">"Logger类中aroundPrintLog方法开始记录日志了...结束"</span>); <span class="comment">// 结束通知</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从上面可以看出，环绕通知是<code>Spring</code>框架为我们提供的一种可以在代码中手动控制增强方法何时执行的方式。</p>
<h4 id="4-2-2-基于注解的AOP配置"><a href="#4-2-2-基于注解的AOP配置" class="headerlink" title="4.2.2 基于注解的AOP配置"></a>4.2.2 基于注解的AOP配置</h4><ol>
<li><p>在<code>bean.xml</code>配置<code>Spring</code>创建容器时要扫描的包</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 配置扫描的包 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">"cn.lizhi"</span>&gt;</span><span class="tag">&lt;/<span class="name">context:component-scan</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 配置Spring开启注解AOP的支持 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">aop:aspectj-autoproxy</span>&gt;</span><span class="tag">&lt;/<span class="name">aop:aspectj-autoproxy</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在通知类中，开启注解</p>
<ul>
<li><code>@Before</code></li>
<li><code>@AfterReturning</code></li>
<li><code>@AfterThrowing</code></li>
<li><code>@After</code></li>
<li><code>@Around</code></li>
</ul>
<p>另外需要额外在通知类中，建立通知方法和切入点的关联，以上的通知注解中的参数就写关联方法的函数名：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Pointcut</span>(<span class="string">"execution(* cn.lizhi.service.impl.*.*(..))"</span>)</span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">pt1</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">   </span><br><span class="line">   <span class="meta">@Before</span>(<span class="string">"pt1()"</span>)</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">beforePrintLog</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       System.out.println(<span class="string">"beforePrintLog记录了日志..."</span>);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>最后需要在配置文件中，开启<code>Spring</code>对注解<code>AOP</code>的支持:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">aop:aspectj-autoproxy</span>&gt;</span><span class="tag">&lt;/<span class="name">aop:aspectj-autoproxy</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>或者采用纯注解的方式(定义配置类):</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan</span>(basePackages=<span class="string">"cn.lizhi"</span>)</span><br><span class="line"><span class="meta">@EnableAspectJAutoProxy</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> class <span class="title">springConfiguration</span><span class="params">()</span></span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意:</strong>使用注解的方式，操作四个普通类型的通知，可能会带来顺序错误的问题。例如：</p>
<blockquote>
<p>beforePrintLog记录了日志…前置<br>模拟用户保存了…<br>afterPrintLog记录了日志…最终<br>afterReturningPrintLog记录了日志…后置</p>
</blockquote>
<p><strong>注意：</strong>这里出现了<code>最终通知</code>在<code>后置通知</code>之前出现的问题。这样会在事务控制中产生一个问题，以上面的银行转账为例，就是最终通知–<code>release</code>操作会在<code>后置通知</code>–<code>commit</code>操作之前执行，那么会造成获取的连接不会是同一个连接(每次调用<code>dao</code>方法时，都会获取连接，由于前面我们使用了<code>ThreadLocal</code>对连接进行了绑定，所以此时获取的连接都是同一个连接，当对其进行<code>release</code>之后，再次获取连接时，那么和之前的连接就都不是同一个连接，因为在<code>release</code>方法中首先对数据库连接进行归还连接池操作，然后再将<code>ThreadLocal</code>和数据库连接进行解绑)，就没有对事务进行相应的控制。因为当你<code>commit</code>时，会从连接池中重新获取连接再与线程进行绑定，而此时的连接并没有做任何的操作，所以<code>commit</code>就是一个空的提交。</p>
<p><strong>因此</strong>,在使用注解的方式时，尽量使用<code>环绕通知</code>代替以上四个<code>普通通知</code>，因为环绕通知中的代码执行一定是由我们自己控制编写的。</p>
</li>
</ol>
<h2 id="五、Spring事务相关"><a href="#五、Spring事务相关" class="headerlink" title="五、Spring事务相关"></a>五、Spring事务相关</h2><p><img src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/placeholder/d570170f4f12e1ee829ca0e85a7dffeb77343a.svg" data-original="https://s1.ax1x.com/2020/09/22/wXM12j.jpg" alt=""></p>
<h3 id="5-1-Spring中JdbcTemplate-介绍"><a href="#5-1-Spring中JdbcTemplate-介绍" class="headerlink" title="5.1 Spring中JdbcTemplate 介绍"></a>5.1 Spring中JdbcTemplate 介绍</h3><h4 id="5-1-1-Spring-JdbcTemplate的内置数据源"><a href="#5-1-1-Spring-JdbcTemplate的内置数据源" class="headerlink" title="5.1.1 Spring JdbcTemplate的内置数据源"></a>5.1.1 Spring JdbcTemplate的内置数据源</h4>   <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 准备数据源，spring的内置数据源</span></span><br><span class="line">DriverManagerDataSource ds = <span class="keyword">new</span> DriverManagerDataSource();</span><br><span class="line">ds.setDriverClassName(<span class="string">"com.mysql.jdbc.Driver"</span>); <span class="comment">// 注入数据库驱动</span></span><br><span class="line">ds.setUrl(<span class="string">"jdbc:mysql://url:3306/draft"</span>); <span class="comment">// 连接地址</span></span><br><span class="line">ds.setUsername(<span class="string">"root"</span>); <span class="comment">// 用户名称</span></span><br><span class="line">ds.setPassword(<span class="string">"1234"</span>); <span class="comment">// 密码</span></span><br><span class="line"><span class="comment">// 1.创建JdbcTemplate对象</span></span><br><span class="line">JdbcTemplate template = <span class="keyword">new</span> JdbcTemplate();</span><br><span class="line"><span class="comment">// 注入数据源</span></span><br><span class="line">template.setDataSource(ds);</span><br></pre></td></tr></table></figure>

<p>通过配置文件，利用<code>IOC</code>思想简化以上操作:</p>
   <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/beans/spring-beans.xsd"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 创建JdbcTemplate对象 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"template"</span> <span class="attr">class</span>=<span class="string">"org.springframework.jdbc.core.JdbcTemplate"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dataSource"</span> <span class="attr">ref</span>=<span class="string">"dateSource"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- dataSource数据源 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"dateSource"</span> <span class="attr">class</span>=<span class="string">"org.springframework.jdbc.datasource.DriverManagerDataSource"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"driverClassName"</span> <span class="attr">value</span>=<span class="string">"com.mysql.jdbc.Driver"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"url"</span> <span class="attr">value</span>=<span class="string">"jdbc:mysql://url/draft"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">"username"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"password"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>代码实现:</p>
   <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ApplicationContext ac = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">"bean.xml"</span>);<span class="comment">// 获取容器</span></span><br><span class="line">        JdbcTemplate template = ac.getBean(<span class="string">"template"</span>, JdbcTemplate<span class="class">.<span class="keyword">class</span>)</span>;<span class="comment">// 获取template对象</span></span><br><span class="line">        template.execute(<span class="string">"insert into account (name,money) values('Lisa',900)"</span>);<span class="comment">// 执行操作</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h4 id="5-1-2-JdbcTemplate的使用-–-CRUD"><a href="#5-1-2-JdbcTemplate的使用-–-CRUD" class="headerlink" title="5.1.2 JdbcTemplate的使用 – CRUD"></a>5.1.2 JdbcTemplate的使用 – CRUD</h4>   <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ApplicationContext ac = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">"bean.xml"</span>);</span><br><span class="line">        JdbcTemplate template = ac.getBean(<span class="string">"template"</span>, JdbcTemplate<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"><span class="comment">//        template.execute("insert into account (name,money) values('Lisa',900)");</span></span><br><span class="line">        <span class="comment">// 1.保存操作</span></span><br><span class="line">        template.update(<span class="string">"insert into account(name,money) values(?,?)"</span>, <span class="string">"Ben"</span>, <span class="number">800f</span>);</span><br><span class="line">        <span class="comment">// 2.更新操作</span></span><br><span class="line">        template.update(<span class="string">"update account set name=?,money=? where id=?"</span>, <span class="string">"Gu"</span>, <span class="number">900f</span>, <span class="number">5</span>);</span><br><span class="line">        <span class="comment">// 3.删除操作</span></span><br><span class="line">        template.update(<span class="string">"delete from account where id=?"</span>, <span class="number">6</span>);</span><br><span class="line">        <span class="comment">// 4.查询所有</span></span><br><span class="line">        List&lt;Account&gt; accounts = template.query(<span class="string">"select * from account"</span>, <span class="keyword">new</span> BeanPropertyRowMapper&lt;Account&gt;(Account<span class="class">.<span class="keyword">class</span>))</span>;</span><br><span class="line">        <span class="comment">// 5.查询单个</span></span><br><span class="line">        Account account = template.queryForObject(<span class="string">"select * from account where id = ?"</span>, <span class="keyword">new</span> BeanPropertyRowMapper&lt;Account&gt;(Account<span class="class">.<span class="keyword">class</span>), 10)</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h4 id="5-1-3-JdbcDaoSupport的使用"><a href="#5-1-3-JdbcDaoSupport的使用" class="headerlink" title="5.1.3 JdbcDaoSupport的使用"></a>5.1.3 JdbcDaoSupport的使用</h4><p>可以用于抽取<code>dao</code>层中的重复代码块。</p>
<p>例如：</p>
<p> <code>dao</code>层的接口：</p>
   <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AccountDao</span> </span>&#123;</span><br><span class="line">   </span><br><span class="line">    <span class="comment">//更新数据</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">updateAccount</span><span class="params">(Account account)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//查询所有</span></span><br><span class="line">    <span class="function">List&lt;Account&gt; <span class="title">findAll</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>实现类:</p>
   <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AccountDaoImpl</span> <span class="keyword">implements</span> <span class="title">AccountDao</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> JdbcTemplate template = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTemplate</span><span class="params">(JdbcTemplate template)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.template = template;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateAccount</span><span class="params">(Account account)</span> </span>&#123;</span><br><span class="line">        template.update(<span class="string">"update account set name=?,money=? where id = ?"</span>, account.getName(), account.getMoney(), account.getId());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Account&gt; <span class="title">findAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        List&lt;Account&gt; lists = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            lists = template.query(<span class="string">"select * from account"</span>, <span class="keyword">new</span> BeanPropertyRowMapper&lt;Account&gt;(Account<span class="class">.<span class="keyword">class</span>))</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (DataAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> lists;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其配置文件<code>bean.xml</code>中<code>bean</code>配置为：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">&lt;!--配置账户的持久层--&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"accountDao"</span> <span class="attr">class</span>=<span class="string">"cn.lizhi.dao.impl.AccountDaoImpl"</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"template"</span> <span class="attr">ref</span>=<span class="string">"template"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- JdbcTemplate对象 --&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"template"</span> <span class="attr">class</span>=<span class="string">"org.springframework.jdbc.core.JdbcTemplate"</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dataSource"</span> <span class="attr">ref</span>=<span class="string">"dateSource"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- DataSource数据源 --&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"dateSource"</span> <span class="attr">class</span>=<span class="string">"org.springframework.jdbc.datasource.DriverManagerDataSource"</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"driverClassName"</span> <span class="attr">value</span>=<span class="string">"com.mysql.jdbc.Driver"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"url"</span> <span class="attr">value</span>=<span class="string">"jdbc:mysql:/url:3306/draft"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">"username"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"password"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>当我们有多个<code>dao</code>的实现方法时，那么这里的重复代码块：</p>
   <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> JdbcTemplate template = <span class="keyword">null</span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTemplate</span><span class="params">(JdbcTemplate template)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.template = template;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所以这里就引发了我们的一个思考，是否可以把这些重复的代码块进行抽取，作为一个单独的类，然后当我们的实现类去继承这个类，进而简化我们的代码。答案是可以的。</p>
<p>现在我们对这个类进行抽取：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JdbcDaoSupport</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> JdbcTemplate jdbcTemplate = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JdbcTemplate <span class="title">getJdbcTemplate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> jdbcTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setJdbcTemplate</span><span class="params">(JdbcTemplate jdbcTemplate)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.jdbcTemplate = jdbcTemplate;</span><br><span class="line">    &#125;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那么我们原有的实现类就需要继承这个类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AccountDaoImpl</span> <span class="keyword">extends</span> <span class="title">JdbcDaoSupport</span> <span class="keyword">implements</span> <span class="title">AccountDao</span> </span>&#123;</span><br><span class="line">   </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateAccount</span><span class="params">(Account account)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.getJdbcTemplate().update(<span class="string">"update account set name=?,money=? where id = ?"</span>, account.getName(), account.getMoney(), account.getId());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Account&gt; <span class="title">findAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        List&lt;Account&gt; lists = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            lists = <span class="keyword">super</span>.getJdbcTemplate().query(<span class="string">"select * from account"</span>, <span class="keyword">new</span> BeanPropertyRowMapper&lt;Account&gt;(Account<span class="class">.<span class="keyword">class</span>))</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (DataAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> lists;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从上面的<code>bean.xml</code>配置文件中，我们看到需要单独对<code>JdbcTemplate</code>进行配置，我们是否可以将<code>JdbcTemplate</code>和<code>DataSource</code>进行统一配置呢。我们将<code>DataSource</code>同样创建在<code>JdbcDaoSupport</code>类中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JdbcDaoSupport</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> JdbcTemplate jdbcTemplate = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">private</span> DataSource dataSource = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JdbcTemplate <span class="title">getJdbcTemplate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> jdbcTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDataSource</span><span class="params">(DataSource dataSource)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (jdbcTemplate == <span class="keyword">null</span>) &#123;</span><br><span class="line">            jdbcTemplate = createJdbcTemplate(dataSource);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> JdbcTemplate <span class="title">createJdbcTemplate</span><span class="params">(DataSource dataSource)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> JdbcTemplate(dataSource);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这里我们创建了一个<code>DataSource</code>对象，并改写了其<code>set</code>方法。<strong>作用:</strong>如果我们直接传递<code>template</code>对象，那么<code>template</code>理所应当有值(有<code>set</code>方法)；如果我们没有传递<code>template</code>对象，我们可以通过<code>DataSource</code>来获取<code>template</code>对象，由于我们改写了其<code>set</code>方法，我们同样可以使<code>template</code>有值(<strong>创建</strong>了有参构造函数的<code>template</code>，并向其传递了<code>dataSource</code>)。</p>
<p>此时<code>bean.xml</code>配置文件中<code>bean</code>的配置为:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--配置账户的持久层--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"accountDao"</span> <span class="attr">class</span>=<span class="string">"cn.lizhi.dao.impl.AccountDaoImpl"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dataSource"</span> <span class="attr">ref</span>=<span class="string">"dateSource"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"dateSource"</span> <span class="attr">class</span>=<span class="string">"org.springframework.jdbc.datasource.DriverManagerDataSource"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"driverClassName"</span> <span class="attr">value</span>=<span class="string">"com.mysql.jdbc.Driver"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"url"</span> <span class="attr">value</span>=<span class="string">"jdbc:mysql://url:3306/draft"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">"username"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"password"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>从上面的<code>bean.xml</code>文件也可以看出，在创建<code>accountDao</code>时，我们是向其注入了<code>dataSource</code>，所以进而就直接触发其<code>set</code>方法(因为<code>accountDaoImpl</code>继承了<code>JdbcDaoSupport</code>)，判断<code>template</code>是否有值，如果没有值，就调用其父类中的<code>createJdbcTemplate</code>方法，其中传递的参数<code>dataSource</code>是来自于<code>bean.xml</code>配置文件中的<code>id=dataSource</code>的<code>bean</code>依赖注入。</p>
<p>以上的操作其实<code>Spring</code>已经帮我们实现了，不需要我们自己手动构建(也算是自己练习了一下源码)。截取其部分源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">JdbcDaoSupport</span> <span class="keyword">extends</span> <span class="title">DaoSupport</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="keyword">private</span> JdbcTemplate jdbcTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JdbcDaoSupport</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">setDataSource</span><span class="params">(DataSource dataSource)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.jdbcTemplate == <span class="keyword">null</span> || dataSource != <span class="keyword">this</span>.jdbcTemplate.getDataSource()) &#123;</span><br><span class="line">            <span class="keyword">this</span>.jdbcTemplate = <span class="keyword">this</span>.createJdbcTemplate(dataSource);</span><br><span class="line">            <span class="keyword">this</span>.initTemplateConfig();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> JdbcTemplate <span class="title">createJdbcTemplate</span><span class="params">(DataSource dataSource)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> JdbcTemplate(dataSource);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> JdbcTemplate <span class="title">getJdbcTemplate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.jdbcTemplate;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>是不是同样的存在<code>createJdbcTemplate(DataSource dataSource)</code>和<code>getJdbcTemplate()</code>方法。从上面的源码中也可以看出<code>Spring</code>在使用<code>set</code>依赖注入时，可以不用定义其变量，只要定义其<code>set</code>属性方法即可。</p>
<p>最后，以上这种继承的方法适用于<code>xml</code>配置文件的方法，不适用于注解开发的方式(因为无法在<code>jar</code>包中的<code>JdbcTemplate</code>上加注解，注入我们的数据类型)。</p>
<h3 id="5-2-Spring中事务控制的API"><a href="#5-2-Spring中事务控制的API" class="headerlink" title="5.2 Spring中事务控制的API"></a>5.2 Spring中事务控制的API</h3><h4 id="5-2-1-Spring事务控制"><a href="#5-2-1-Spring事务控制" class="headerlink" title="5.2.1 Spring事务控制"></a>5.2.1 Spring事务控制</h4><ol>
<li><code>JavaEE</code>体系进行分层开发，事务处理处于业务层，<code>Spring</code>提供了分层设计<strong>业务层</strong>的事务处理解决方案。</li>
<li><code>Spring</code>框架为我们提供了一组事务控制的接口</li>
<li><code>Spring</code>的事务控制都是基于<code>AOP</code>的，它既可以使用编程的方式实现，也可以使用配置的方法实现。</li>
</ol>
<p>依赖导入：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-tx<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.0.2.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="5-2-2-Spring中事务控制的API介绍"><a href="#5-2-2-Spring中事务控制的API介绍" class="headerlink" title="5.2.2 Spring中事务控制的API介绍"></a>5.2.2 Spring中事务控制的API介绍</h4><ol>
<li><p><code>PlatformTransactionManager</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PlatformTransactionManager</span> </span>&#123;</span><br><span class="line">    <span class="function">TransactionStatus <span class="title">getTransaction</span><span class="params">(@Nullable TransactionDefinition var1)</span> <span class="keyword">throws</span> TransactionException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">commit</span><span class="params">(TransactionStatus var1)</span> <span class="keyword">throws</span> TransactionException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">rollback</span><span class="params">(TransactionStatus var1)</span> <span class="keyword">throws</span> TransactionException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此接口存在<code>commit</code>、<code>rollback</code>方法，即为通知<code>bean</code>。</p>
<p><code>PlatformTransactionManager</code>接口提供事务操作的方法，包含有3个具体的操作：</p>
</li>
</ol>
<ul>
<li><p>获取事务状态信息</p>
<ul>
<li><p><code>TransactionStatus getTransaction(@Nullable TransactionDefinition var1)</code></p>
<ul>
<li>提交事务<ul>
<li><code>void commit(TransactionStatus var1)</code></li>
</ul>
</li>
<li>回滚事务<ul>
<li><code>void rollback(TransactionStatus var1)</code></li>
</ul>
</li>
</ul>
<p>我们需要使用的是其实现类：</p>
<ol>
<li><p><code>org.springframework.jdbc.datasource.DataSourceTransactionManager</code></p>
<p>使用<code>Spring JDBC</code>或<code>iBatis</code>进行持久化数据时使用</p>
</li>
<li><p><code>org.springframework.orm.hibernate5.HibernateTransactionManager</code></p>
<p>使用<code>Hibernate</code>版本进行持久化数据时使用</p>
</li>
</ol>
</li>
</ul>
</li>
</ul>
<ol start="3">
<li><p><code>TransactionDefinition</code></p>
<ul>
<li><p>获取事务对象名称</p>
<p><code>String getName()</code></p>
</li>
<li><p>获取事务隔离级别:有四个隔离级别，<code>Spring</code>默认使用的是数据库的隔离级别</p>
<p><code>int getIsolationLevel()</code></p>
</li>
<li><p>获取事务传播行为:定义什么时候需要用事务(增、删、改)，什么时候事务可有可无(查询)</p>
<p><code>int getPropagationBehavior()</code></p>
</li>
<li><p>获取事务超时时间</p>
<p><code>int getTimeout()</code></p>
</li>
<li><p>获取事务是否只读(建议查询方法下为只读)</p>
<p><code>boolean isReadOnly()</code></p>
<p>读写型事务：增加、删除、修改开启事务</p>
<p>只读型事务：执行查询时，也会开启事务</p>
</li>
</ul>
</li>
</ol>
<h4 id="5-2-3-事务的隔离级别"><a href="#5-2-3-事务的隔离级别" class="headerlink" title="5.2.3 事务的隔离级别"></a>5.2.3 事务的隔离级别</h4><p>事务隔离级别反映事务提交并发访问时的处理态度</p>
<ul>
<li><code>ISOLATION_DEFAULT</code><ul>
<li>默认级别，归属下列某一种</li>
</ul>
</li>
<li><code>ISOLATION_READ_UNCOMMITTED</code><ul>
<li>可以读取未提交数据</li>
</ul>
</li>
<li><code>ISOLATION_READ_COMMITTED</code><ul>
<li>只能读取已提交数据，解决脏读问题(<code>Oracle</code>默认级别)</li>
</ul>
</li>
<li><code>ISOLATION_REPEATABLE_READ</code><ul>
<li>是否读取其他事务提交修改后的数据，解决不可重复读问题(<code>MySQL</code>默认级别)</li>
</ul>
</li>
<li><code>ISOLATION_SERIALIZABLE</code><ul>
<li>是否读取其他事务提交添加后的数据，解决幻读问题</li>
</ul>
</li>
</ul>
<h4 id="5-2-4-事务的隔离级别"><a href="#5-2-4-事务的隔离级别" class="headerlink" title="5.2.4 事务的隔离级别"></a>5.2.4 事务的隔离级别</h4><ul>
<li><strong><code>REQUIRED</code>:如果当前没有事务，就新建一个事务，如果已经存在一个事务中，加入到这个事务中。一般的选择(默认值)</strong></li>
<li><strong><code>SUPPORTS</code>:支持当前事务，如果当前没有事务，就以非事务方式执行(没有事务)</strong></li>
<li><code>MANDATORY</code>:使用当前的事务，如果当前没有事务，就抛出异常</li>
<li><code>REQUERS_NEW</code>:新建事务，如果当前在事务中，把当前事务挂起。</li>
<li><code>NOT_SUPPORTED</code>:以非事务方式执行操作，如果当前存在事务，就把当前事务挂起。</li>
<li><code>NEVER</code>:以非事务方式运行，如果当前存在事务，抛出异常。</li>
<li><code>NESTED</code>:如果当前存在事务，则在嵌套事务内执行。如果当前没有事务，则执行<code>REQUIRED</code>类似的操作。</li>
</ul>
<h4 id="5-2-5-TransactionStatus接口"><a href="#5-2-5-TransactionStatus接口" class="headerlink" title="5.2.5 TransactionStatus接口"></a>5.2.5 TransactionStatus接口</h4><p>此接口提供的是事务具体的运行状态，<code>TransacitonStatus</code>接口描述了某个<strong>时间点</strong>上事务对象的状态信息，包含有6个具体的操作：</p>
<ul>
<li>刷新事务<ul>
<li><code>void flush()</code></li>
</ul>
</li>
<li>获取是否存在存储点(相当于回滚的断点，回滚时不是回滚到最初的开始，而是回滚到设置的存储点处)<ul>
<li><code>boolean hasSavepoint()</code></li>
</ul>
</li>
<li>获取事务是否完成<ul>
<li><code>boolean isCompleted()</code></li>
</ul>
</li>
<li>获取事务是否为新的事务<ul>
<li><code>boolean isNewTransaction()</code></li>
</ul>
</li>
<li>获取事务是否回滚<ul>
<li><code>boolean isRollbackOnly()</code></li>
</ul>
</li>
<li>设置事务回滚<ul>
<li><code>void setRollbackOnly()</code></li>
</ul>
</li>
</ul>
<h3 id="5-3-Spring中基于XML的声明式事务控制配置步骤"><a href="#5-3-Spring中基于XML的声明式事务控制配置步骤" class="headerlink" title="5.3 Spring中基于XML的声明式事务控制配置步骤"></a>5.3 Spring中基于<code>XML</code>的声明式事务控制配置步骤</h3><ol>
<li><p>配置事务管理器</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"transactionManager"</span> 		<span class="attr">class</span>=<span class="string">"org.springframework.jdbc.datasource.DataSourceTransactionManager"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dataSource"</span> <span class="attr">ref</span>=<span class="string">"dateSource"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>配置事务的通知</p>
<p>此时我们需要导入事务的约束 <code>tx</code>名称空间和约束，同时也需要<code>aop</code></p>
<p>使用<code>tx:advice</code>标签配置事务通知</p>
<ul>
<li>属性：<ul>
<li><code>id</code>：给事务通知起一个唯一标识</li>
<li><code>transaction-manager</code>:给事务通知提供一个事务管理器引用</li>
</ul>
</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 配置事务通知 --&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">tx:advice</span> <span class="attr">id</span>=<span class="string">"txAdvice"</span> <span class="attr">transaction-manager</span>=<span class="string">"transactionManager"</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">tx:advice</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>配置<code>AOP</code>中的通用切入点表达式</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">aop:config</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 通用表达式配置 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">aop:pointcut</span> <span class="attr">id</span>=<span class="string">"pt1"</span> <span class="attr">expression</span>=<span class="string">"execution(* cn.lizhi.service.*.*(..))"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">aop:config</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>建立事务通知和切入点表达式的对应关系</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">aop:config</span>&gt;</span></span><br><span class="line">       <span class="comment">&lt;!-- 通用表达式配置 --&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">aop:pointcut</span> <span class="attr">id</span>=<span class="string">"pt1"</span> <span class="attr">expression</span>=<span class="string">"execution(* cn.lizhi.service.*.*(..))"</span>/&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">aop:advisor</span> <span class="attr">advice-ref</span>=<span class="string">"txAdvice"</span> <span class="attr">pointcut-ref</span>=<span class="string">"pt1"</span>&gt;</span><span class="tag">&lt;/<span class="name">aop:advisor</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">aop:config</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>配置事务的属性 – <code>tx:attributes</code></p>
<p>是在事务的通知<code>tx:advice</code>标签的内部 <code>tx:method</code></p>
<ul>
<li><code>name</code>属性：表明业务层中哪个方法需要被事务控制。</li>
</ul>
<p>配置事务的属性:</p>
<ul>
<li><code>isolation</code>:用于指定事务的隔离级别。默认值是<code>DEFAULT</code>,表示使用数据库的默认隔离级别。</li>
<li><code>propagation</code>:用于指定事务的传播行为。默认值是<code>REQUIRED</code>,表示一定会有事务，增删改的选择。查询方法可以选择<code>SUPPORTS</code>。</li>
<li><code>read-only</code>:用于指定事务是否只读。只有查询方法才能设置为<code>true</code>。默认值是<code>false</code>，表示读写。</li>
<li><code>timeout</code>:用于指定事务的超时时间，默认值是-1,表示永不超时。如果指定了数值，以秒为单位。</li>
<li><code>rollback-for</code>:用于指定一个异常。当产生该异常时，事务回滚，产生其他异常时，事务不回滚。没有默认值，表示任何异常都回滚。</li>
<li><code>no-rollback-for</code>:用于指定一个异常，当产生异常时，事务不回滚，产生其他异常时事务回滚。没有默认值，表示任何异常都回滚。</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 配置事务通知 --&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">tx:advice</span> <span class="attr">id</span>=<span class="string">"txAdvice"</span> <span class="attr">transaction-manager</span>=<span class="string">"transactionManager"</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">tx:attributes</span>&gt;</span></span><br><span class="line">           <span class="comment">&lt;!-- 增删改事务的控制 --&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">"transfer"</span> <span class="attr">propagation</span>=<span class="string">"REQUIRED"</span> <span class="attr">read-only</span>=<span class="string">"false"</span>/&gt;</span></span><br><span class="line">           <span class="comment">&lt;!-- 查询方法事务的控制 --&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">"find*"</span> <span class="attr">propagation</span>=<span class="string">"SUPPORTS"</span> <span class="attr">read-only</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">tx:attributes</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">tx:advice</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>需要命名规范，通过通配符配置方法名。</p>
</li>
</ol>
<p>最终<code>bean.xml</code>中的配置为:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:aop</span>=<span class="string">"http://www.springframework.org/schema/aop"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:tx</span>=<span class="string">"http://www.springframework.org/schema/tx"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/tx</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/tx/spring-tx.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/aop</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/aop/spring-aop.xsd"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--配置账户的持久层--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"accountDao"</span> <span class="attr">class</span>=<span class="string">"cn.lizhi.dao.impl.AccountDaoImpl"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dataSource"</span> <span class="attr">ref</span>=<span class="string">"dateSource"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 配置账户的业务层 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"accountService"</span> <span class="attr">class</span>=<span class="string">"cn.lizhi.service.impl.AccountServiceImpl"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dao"</span> <span class="attr">ref</span>=<span class="string">"accountDao"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 配置数据源 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"dateSource"</span> <span class="attr">class</span>=<span class="string">"org.springframework.jdbc.datasource.DriverManagerDataSource"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"driverClassName"</span> <span class="attr">value</span>=<span class="string">"com.mysql.jdbc.Driver"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"url"</span> <span class="attr">value</span>=<span class="string">"jdbc:mysql://url:3306/draft"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">"username"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"password"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 配置事务管理器 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"transactionManager"</span> <span class="attr">class</span>=<span class="string">"org.springframework.jdbc.datasource.DataSourceTransactionManager"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dataSource"</span> <span class="attr">ref</span>=<span class="string">"dateSource"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 配置事务通知 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tx:advice</span> <span class="attr">id</span>=<span class="string">"txAdvice"</span> <span class="attr">transaction-manager</span>=<span class="string">"transactionManager"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tx:attributes</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">"transfer"</span> <span class="attr">propagation</span>=<span class="string">"REQUIRED"</span> <span class="attr">read-only</span>=<span class="string">"false"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">"find*"</span> <span class="attr">propagation</span>=<span class="string">"SUPPORTS"</span> <span class="attr">read-only</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tx:attributes</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tx:advice</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- AOP配置 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">aop:config</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 通用表达式配置 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">aop:pointcut</span> <span class="attr">id</span>=<span class="string">"pt1"</span> <span class="attr">expression</span>=<span class="string">"execution(* cn.lizhi.service.*.*(..))"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">aop:advisor</span> <span class="attr">advice-ref</span>=<span class="string">"txAdvice"</span> <span class="attr">pointcut-ref</span>=<span class="string">"pt1"</span>&gt;</span><span class="tag">&lt;/<span class="name">aop:advisor</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">aop:config</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="5-4-Spring中基于注解的声明式事务控制配置步骤"><a href="#5-4-Spring中基于注解的声明式事务控制配置步骤" class="headerlink" title="5.4 Spring中基于注解的声明式事务控制配置步骤"></a>5.4 Spring中基于注解的声明式事务控制配置步骤</h3><ol>
<li><p>配置事务管理器</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 配置事务管理器 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"transactionManager"</span> <span class="attr">class</span>=<span class="string">"org.springframework.jdbc.datasource.DataSourceTransactionManager"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dataSource"</span> <span class="attr">ref</span>=<span class="string">"dateSource"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>开启<code>spring</code>对注解事务的支持</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tx:annotation-driven</span> <span class="attr">transaction-manager</span>=<span class="string">"transactionManager"</span>&gt;</span><span class="tag">&lt;/<span class="name">tx:annotation-driven</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在需要事务支持的地方使用<code>@Transaction</code>注解</p>
</li>
</ol>
<p>以上中的注意事项有：因为是使用注解式配置，所以在<code>dao</code>层，不能通过继承<code>JdbcDaoSupport</code>的方式简化我们的代码，故需要在<code>bean.xml</code>中对<code>SpringJdbcTemplate</code>进行配置。</p>
<h4 id="5-4-1-基于纯注解的声明式事务控制"><a href="#5-4-1-基于纯注解的声明式事务控制" class="headerlink" title="5.4.1 基于纯注解的声明式事务控制"></a>5.4.1 基于纯注解的声明式事务控制</h4><p>通过配置类的方式实现。</p>
<ol>
<li><p><code>SpringConfig</code>配置类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ComponentScan</span>(<span class="string">"cn.lizhi"</span>)</span><br><span class="line"><span class="meta">@Import</span>(&#123;JdbcConfig<span class="class">.<span class="keyword">class</span>, <span class="title">TransactionConfig</span>.<span class="title">class</span>&#125;)</span></span><br><span class="line">@PropertySource("classpath:jdbcConfig.properties")</span><br><span class="line"><span class="meta">@EnableTransactionManagement</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringConfig</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>JdbcConfig</code>配置类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JdbcConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;driver&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String driver;</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;username&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;password&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;url&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String url;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span>(<span class="string">"template"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> JdbcTemplate <span class="title">getJdbcTemplate</span><span class="params">(DataSource dataSource)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> JdbcTemplate(dataSource);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span>(<span class="string">"dataSource"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">getDataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        DriverManagerDataSource dataSource = <span class="keyword">new</span> DriverManagerDataSource();</span><br><span class="line">        dataSource.setDriverClassName(driver);</span><br><span class="line">        dataSource.setUsername(username);</span><br><span class="line">        dataSource.setPassword(password);</span><br><span class="line">        dataSource.setUrl(url);</span><br><span class="line">        <span class="keyword">return</span> dataSource;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>TransactionConfig</code>配置类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransactionConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span>(<span class="string">"transactionManager"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSourceTransactionManager <span class="title">getTransactionManager</span><span class="params">(DataSource dataSource)</span> </span>&#123;</span><br><span class="line">        DataSourceTransactionManager transactionManager = <span class="keyword">new</span> DataSourceTransactionManager();</span><br><span class="line">        transactionManager.setDataSource(dataSource);</span><br><span class="line">        <span class="keyword">return</span> transactionManager;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="5-5-Spring编程式事务控制"><a href="#5-5-Spring编程式事务控制" class="headerlink" title="5.5 Spring编程式事务控制"></a>5.5 Spring编程式事务控制</h3><p>因为我们的事务管理都是由<code>Spring</code>进行控制，所以我们都需要进行事务管理器的配置。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 配置事务管理器 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"transactionManager"</span> <span class="attr">class</span>=<span class="string">"org.springframework.jdbc.datasource.DataSourceTransactionManager"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dataSource"</span> <span class="attr">ref</span>=<span class="string">"dateSource"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>当有了事务管理器之后，<code>Spring</code>同样为我们提供了事务模板，供我们具体使用事务控制的相关方法(相当于代理对象，对业务层方法进行增强)：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 事务模板对象  --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"transactionTemplate"</span> <span class="attr">class</span>=<span class="string">"org.springframework.transaction.support.TransactionTemplate"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"transactionManager"</span> <span class="attr">ref</span>=<span class="string">"transactionManager"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>查看具体的<code>TransactionTemplate</code>源码，其中一段为:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">execute</span><span class="params">(TransactionCallback&lt;T&gt; action)</span> <span class="keyword">throws</span> TransactionException </span>&#123;</span><br><span class="line">    Assert.state(<span class="keyword">this</span>.transactionManager != <span class="keyword">null</span>, <span class="string">"No PlatformTransactionManager set"</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.transactionManager <span class="keyword">instanceof</span> CallbackPreferringPlatformTransactionManager) &#123;</span><br><span class="line">        <span class="keyword">return</span> ((CallbackPreferringPlatformTransactionManager)<span class="keyword">this</span>.transactionManager).execute(<span class="keyword">this</span>, action);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        TransactionStatus status = <span class="keyword">this</span>.transactionManager.getTransaction(<span class="keyword">this</span>);</span><br><span class="line">        Object result;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            result = action.doInTransaction(status);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Error | RuntimeException var5) &#123;</span><br><span class="line">            <span class="keyword">this</span>.rollbackOnException(status, var5);</span><br><span class="line">            <span class="keyword">throw</span> var5;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable var6) &#123;</span><br><span class="line">            <span class="keyword">this</span>.rollbackOnException(status, var6);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UndeclaredThrowableException(var6, <span class="string">"TransactionCallback threw undeclared checked exception"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.transactionManager.commit(status);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在上面的异常代码块中，可以看出，当执行不通过时，执行<code>this.rollbackOnException(status, var5)</code>，进行事务回滚；当执行通过时，<code>try</code>代码块中执行事务状态<code>result = action.doInTransaction(status)</code>，最后执行<code>this.transactionManager.commit(status)</code>，进行事务的提交。</p>
<p>具体使用：</p>
<p>模仿<code>TransactionTemplate</code>中的<code>execute</code>方法，在业务层中需要事务控制的方法中，执行该方法，该方法中的参数是一个接口，需要我们自己实现，其内容就填写我们需要控制的业务具体代码块。</p>
<img src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/placeholder/d570170f4f12e1ee829ca0e85a7dffeb77343a.svg" data-original="https://s1.ax1x.com/2020/09/22/wXMua8.png" style="zoom:150%;" />

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transfer</span><span class="params">(<span class="keyword">final</span> String startName, <span class="keyword">final</span> String endName, <span class="keyword">final</span> Float money)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        template.execute(<span class="keyword">new</span> TransactionCallback&lt;Object&gt;() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> Object <span class="title">doInTransaction</span><span class="params">(TransactionStatus transactionStatus)</span> </span>&#123;</span><br><span class="line">                Account startAccount = dao.findByName(startName); <span class="comment">// 出款人账号 -- 会获取连接</span></span><br><span class="line">                Account endAccount = dao.findByName(endName); <span class="comment">// 收款人账号 -- 会获取连接</span></span><br><span class="line">                Float startMoney = startAccount.getMoney();</span><br><span class="line">                startAccount.setMoney(startMoney - money);</span><br><span class="line">                Float endMoney = endAccount.getMoney();</span><br><span class="line">                endAccount.setMoney(endMoney + money);</span><br><span class="line">                dao.update(startAccount, startAccount.getId()); <span class="comment">// 会获取连接</span></span><br><span class="line"><span class="comment">//                int a = 3 / 0;</span></span><br><span class="line">                dao.update(endAccount, endAccount.getId()); <span class="comment">// 会获取连接</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>由于编程式的事务控制，又增加了代码的冗余，违背了<code>AOP</code>的初心，所以实际中很少使用这种事务控制方式。</p>
<h2 id="六、Spring整合JavaWeb"><a href="#六、Spring整合JavaWeb" class="headerlink" title="六、Spring整合JavaWeb"></a>六、Spring整合JavaWeb</h2><p>整合步骤：</p>
<ol>
<li><p>导包 —— Spring相关的Jar包</p>
</li>
<li><p>写配置</p>
<ul>
<li>将所有组件加入容器中，并能正确获取<ul>
<li><code>@Controller</code>：<code>Servlet</code>层；但是不能标注在<code>Servlet</code>层，因为这个对象是Tomcat创建的，而非<code>Spring</code>容器进行创建的。</li>
<li><code>@Service</code>：业务逻辑层</li>
<li><code>@Repository</code>：dao层</li>
<li><code>@Component</code>：其他组件</li>
</ul>
</li>
</ul>
</li>
<li><p>每个组件之间自动装配</p>
</li>
<li><p>配置出声明式事务</p>
<ul>
<li>配置数据源。配置数据源之前，可抽离出<code>JDBC</code>配置文件。</li>
<li><code>JDBCTemplate</code>操作数据库。给其注入数据源。</li>
<li>配置事务管理器 – 让其控制住数据源<ul>
<li>注解方式</li>
<li>XML配置方式</li>
</ul>
</li>
</ul>
</li>
<li><p>IOC容器创建和销毁都要在合适的时机完成；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">项目启动：&#123;</span><br><span class="line">    IOC创建完成</span><br><span class="line">&#125;</span><br><span class="line">项目销毁：&#123;</span><br><span class="line">    IOC销毁</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过监听器完成这项工作，监听器是Tomcat中的，因此，配置在web.xml中。采用Spring提供的监听器(ContextLoaderListener)；容器位置，即为Spring配置文件。</p>
<p>这个监听器创建好的IOC容器在ContextLoader —— 这个属性就是IoC容器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> WebApplicationContext context;</span><br></pre></td></tr></table></figure>

<p>通过静态方法能获取——<code>getCurrentWebApplicationContext</code></p>
</li>
</ol>

          
            <br>
            
  
    
    

<section class="widget copyright  desktop mobile">
  <div class='content'>
    
      <blockquote>
        
          
            <p>博客内容遵循 署名-非商业性使用-相同方式共享 4.0 国际 (CC BY-NC-SA 4.0) 协议</p>

          
        
          
            <p>本文永久链接是：<a href=https://chemlez.github.io/2020/09/22/Spring%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0(%E5%85%A8)/>https://chemlez.github.io/2020/09/22/Spring%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0(%E5%85%A8)/</a></p>
          
        
      </blockquote>
    
  </div>
</section>

  

  
    
    
  

  <section class="widget related_posts  desktop mobile">
    
  <header>
    
      <i class="fas fa-bookmark fa-fw" aria-hidden="true"></i><span class='name'>相关文章</span>
    
  </header>


    <div class="content">
      <ul class="popular-posts"><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="/2020/11/18/ssm框架的整合/" title="ssm框架的整合" rel="bookmark">ssm框架的整合</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="/2019/11/18/JDBC基础使用/" title="JDBC基础使用" rel="bookmark">JDBC基础使用</a></h3></div></li></ul>
    </div>
  </section>


  


          
        </div>
        
          


  <section class='meta' id="footer-meta">
    <div class='new-meta-box'>
      
        
          <div class="new-meta-item date" itemprop="dateUpdated" datetime="2021-06-18T10:32:43+08:00">
  <a class='notlink'>
    <i class="fas fa-save" aria-hidden="true"></i>
    <p>更新于：Jun 18, 2021</p>
  </a>
</div>

        
      
        
          
  
  <div class="new-meta-item meta-tags"><a class="tag" href="/tags/Spring/" rel="nofollow"><i class="fas fa-hashtag" aria-hidden="true"></i><p>Spring</p></a></div>


        
      
        
          
  <div class="new-meta-item share -mob-share-list">
  <div class="-mob-share-list share-body">
    
      
        <a class="-mob-share-qq" title="" rel="external nofollow noopener noreferrer"
          
          href="http://connect.qq.com/widget/shareqq/index.html?url=https://chemlez.github.io/2020/09/22/Spring%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0(%E5%85%A8)/&title=Spring学习笔记(全) - Liz'blog&summary=0、基本介绍Spring是对业务层的操作,同时可以整合Mybatis框架和Spring MVC框架。下图是MVC结构：
"
          
          >
          
            <img src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/placeholder/d570170f4f12e1ee829ca0e85a7dffeb77343a.svg" data-original="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/logo/128/qq.png">
          
        </a>
      
    
      
        <a class="-mob-share-qzone" title="" rel="external nofollow noopener noreferrer"
          
          href="https://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=https://chemlez.github.io/2020/09/22/Spring%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0(%E5%85%A8)/&title=Spring学习笔记(全) - Liz'blog&summary=0、基本介绍Spring是对业务层的操作,同时可以整合Mybatis框架和Spring MVC框架。下图是MVC结构：
"
          
          >
          
            <img src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/placeholder/d570170f4f12e1ee829ca0e85a7dffeb77343a.svg" data-original="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/logo/128/qzone.png">
          
        </a>
      
    
      
        <a class="-mob-share-weibo" title="" rel="external nofollow noopener noreferrer"
          
          href="http://service.weibo.com/share/share.php?url=https://chemlez.github.io/2020/09/22/Spring%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0(%E5%85%A8)/&title=Spring学习笔记(全) - Liz'blog&summary=0、基本介绍Spring是对业务层的操作,同时可以整合Mybatis框架和Spring MVC框架。下图是MVC结构：
"
          
          >
          
            <img src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/placeholder/d570170f4f12e1ee829ca0e85a7dffeb77343a.svg" data-original="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/logo/128/weibo.png">
          
        </a>
      
    
      
        
        <div class='hoverbox'>
          <a><img src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/placeholder/d570170f4f12e1ee829ca0e85a7dffeb77343a.svg" data-original="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/logo/128/wechat.png"></a>
          <div class='target'>
            <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAVgAAAFYCAAAAAAzB7ucAAAEZUlEQVR42u3aQXLjMAwEQP//094XbAkYQJScat4cRxTZ9IGYwudr3DI+CMCCNcCCBWuAPQL7Ccf/nr+at/re7vouN3wx/5oHWLBgwYIFCxYs2KOw5QtwETZ9rjpP973dA4g9wIIFCxYsWLBgwT4CW72wdxc0LSDSA7pab1owgAULFixYsGDBgv1t2DQQjhsiilDTgwILFixYsGDBggX7t2GnF+/v8thqNAELFixYsGDBggX7W7DbDQ3VwDtttNgCfF0nDFiwYMGCBQsWLNgSbBpY/9XPsQdYsGDBggULFizYI7DbDRTVRo3qRb4bqKdgax5gwYIFCxYsWLBgj8B2g+EpQDXYToPpKej0hwAWLFiwYMGCBQv2DGwKlwKkDRhdwGmQnRYyYMGCBQsWLFiwYM/AdiGqC6l+P72YV+dJg/t2wA4WLFiwYMGCBQv2COy0MWIamHeD6+k606C8/MMDCxYsWLBgwYIF+wrYtKFhqyFkOu+pgBssWLBgwYIFCxbsM7BpMJ0WDtP3d4PwaeNGOWgHCxYsWLBgwYIFexS2u9FugdANlNP3d+ddL1TAggULFixYsGDBHoHtLnR6wZ4WEFsNF9uNH2DBggULFixYsGDPwraD3KXP3aC8+3/pwY4LJbBgwYIFCxYsWLBHYKcFQlo4bAfZ3YImLVTAggULFixYsGDBvgu2+8IUKA2+twqFaZAOFixYsGDBggUL9l2w1Y2lF/ZuQXFXoH17gwhYsGDBggULFizYI7DdF3cD4O7BpO9NQbo/DLBgwYIFCxYsWLDvgN1upNgOuLvPbxUscYEEFixYsGDBggUL9hHYrYJha77ugXaD6+73l+8BCxYsWLBgwYIFexR2q5GiGmSnG5gG5ukBxQUCWLBgwYIFCxYs2Fthu2M7yN4+wFONJ+XKCyxYsGDBggULFuwtsN9wTEG2wNLgez2oBwsWLFiwYMGCBfsobBocp/OkhchWg0e3cQUsWLBgwYIFCxbss7DVC/A0GN66iHfXkxYI3cIALFiwYMGCBQsW7FnYdGPdC/jdjRPTQLy6n7jyAgsWLFiwYMGCBbsK291AGjBvX8y769sO1MGCBQsWLFiwYME+C7t10U4LhmngvnXBXytowIIFCxYsWLBgwR6BTRsZphfpKVh1o1uFSfl7sGDBggULFixYsEdhp8FyCpYeZBeo28CReoAFCxYsWLBgwYI9C5uONMhOg+YUZjt4v2zYAAsWLFiwYMGCBXsr7HQhW40Y6cW/G4SnDRrlfYIFCxYsWLBgwYI9CpsGzFtB8rRhIw3guwXN5d/BggULFixYsGDBPgKbbrh74U9BthtNtoJwsGDBggULFixYsL8F2w2KU9j04r8d0F/uFyxYsGDBggULFuxPwU6hphvfaviYzgMWLFiwYMGCBQv2GdjtwHl64d4+wO31lBs2wIIFCxYsWLBgwd4C2x3V56fBdnf+uwoRsGDBggULFixYsO+CNXYHWLBgDbBgwRpgbx3/AIDfVFj7uDE+AAAAAElFTkSuQmCC">
          </div>
        </div>
      
    
  </div>
</div>



        
      
    </div>
  </section>


        
        
          <div class="prev-next">
            
              <a class='prev' href='/2020/10/02/SpringMVC%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E8%AE%B0%E5%BD%95/'>
                <p class='title'><i class="fas fa-chevron-left" aria-hidden="true"></i>SpringMVC学习笔记记录</p>
                <p class='content'>0 、概述服务器端分成三层架构。

一、环境搭建1.1 Maven环境的创建
导入坐标依赖
123456789101112131415161718192021222324252627282930...</p>
              </a>
            
            
              <a class='next' href='/2020/09/06/Mybatis%E6%A1%86%E6%9E%B6%E4%BB%8B%E7%BB%8D%E4%B8%8E%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8%E7%AC%94%E8%AE%B0/'>
                <p class='title'>Mybatis框架介绍与基本使用笔记<i class="fas fa-chevron-right" aria-hidden="true"></i></p>
                <p class='content'>Mybatis框架介绍与基本使用笔记注意:一般的一个Maven工程首先注入的依赖包含数据库驱动依赖，日志依赖，测试依赖
domain中的实体类实现serizlizable接口序列化的原因:

最...</p>
              </a>
            
          </div>
        
      </section>
    </article>
  

  
    <!-- 显示推荐文章和评论 -->



  <article class="post white-box comments shadow floatable">
    <section class="article typo">
      <p ct><i class='fas fa-comments'></i> Comment</p>
      
      
      
      
      
        <section id="comments">
          <div id="valine_container" class="valine_thread">
            <i class="fas fa-spinner fa-spin fa-fw"></i>
          </div>
        </section>
      
    </section>
  </article>


  




<!-- 根据页面mathjax变量决定是否加载MathJax数学公式js -->



  <script>
    window.subData = {
      title: 'Spring学习笔记(全)',
      tools: true
    }
  </script>


</div>
<aside class='l_side'>
  
  
    
    

<section class="widget blogger shadow floatable desktop">
  <div class='content'>
    
      <div class='avatar'>
        <img class='avatar' src='https://s1.ax1x.com/2020/03/13/8mvbCj.jpg'/>
      </div>
    
    
      <div class='text'>
        
        
        
          <p><span id="jinrishici-sentence">Liz'blog</span></p>
          <script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script>
        
      </div>
    
    
      <div class="social-wrapper">
        
          
            <a href="https://github.com/Chemlez"
              class="social fab fa-github flat-btn"
              target="_blank"
              rel="external nofollow noopener noreferrer">
            </a>
          
        
          
            <a href="https://weibo.com/u/5653780011?nick=Sane_z&is_all=1"
              class="social fab fa-weibo flat-btn"
              target="_blank"
              rel="external nofollow noopener noreferrer">
            </a>
          
        
          
            <a href="mailto:liz_1106@163.com"
              class="social fas fa-envelope flat-btn"
              target="_blank"
              rel="external nofollow noopener noreferrer">
            </a>
          
        
      </div>
    
  </div>
</section>

  

  
    
    
  

  <section class="widget category shadow floatable desktop">
    
  <header>
    
      <a href='/categories/'><i class="fas fa-folder-open fa-fw" aria-hidden="true"></i><span class='name'>文章分类</span></a>
    
  </header>


    <div class='content'>
      <ul class="entry navigation">
        
          <li><a class="flat-box"
            title="/categories/Java/" href="/categories/Java/"
            id="categoriesJava"
            ><div class='name'>Java</div><div class='badge'>(18)</div></a></li>
        
          <li><a class="flat-box child"
            title="/categories/Java/%E6%A1%86%E6%9E%B6/" href="/categories/Java/%E6%A1%86%E6%9E%B6/"
            id="categoriesJavaE6A186E69EB6"
            ><div class='name'>框架</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box"
            title="/categories/Linux/" href="/categories/Linux/"
            id="categoriesLinux"
            ><div class='name'>Linux</div><div class='badge'>(2)</div></a></li>
        
          <li><a class="flat-box"
            title="/categories/Machine-Learning/" href="/categories/Machine-Learning/"
            id="categoriesMachine-Learning"
            ><div class='name'>Machine Learning</div><div class='badge'>(2)</div></a></li>
        
          <li><a class="flat-box child"
            title="/categories/Machine-Learning/sklearn/" href="/categories/Machine-Learning/sklearn/"
            id="categoriesMachine-Learningsklearn"
            ><div class='name'>sklearn</div><div class='badge'>(2)</div></a></li>
        
          <li><a class="flat-box"
            title="/categories/Mongodb/" href="/categories/Mongodb/"
            id="categoriesMongodb"
            ><div class='name'>Mongodb</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box"
            title="/categories/Nginx/" href="/categories/Nginx/"
            id="categoriesNginx"
            ><div class='name'>Nginx</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box"
            title="/categories/Python/" href="/categories/Python/"
            id="categoriesPython"
            ><div class='name'>Python</div><div class='badge'>(3)</div></a></li>
        
          <li><a class="flat-box child"
            title="/categories/Python/%E7%88%AC%E8%99%AB/" href="/categories/Python/%E7%88%AC%E8%99%AB/"
            id="categoriesPythonE788ACE899AB"
            ><div class='name'>爬虫</div><div class='badge'>(2)</div></a></li>
        
          <li><a class="flat-box"
            title="/categories/git/" href="/categories/git/"
            id="categoriesgit"
            ><div class='name'>git</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box"
            title="/categories/%E5%89%8D%E7%AB%AF/" href="/categories/%E5%89%8D%E7%AB%AF/"
            id="categoriesE5898DE7ABAF"
            ><div class='name'>前端</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box"
            title="/categories/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" href="/categories/%E5%A4%9A%E7%BA%BF%E7%A8%8B/"
            id="categoriesE5A49AE7BABFE7A88B"
            ><div class='name'>多线程</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box"
            title="/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/" href="/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/"
            id="categoriesE695B0E68DAEE7BB93E69E84E4B88EE7AE97E6B395"
            ><div class='name'>数据结构与算法</div><div class='badge'>(3)</div></a></li>
        
          <li><a class="flat-box"
            title="/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" href="/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"
            id="categoriesE8AEBEE8AEA1E6A8A1E5BC8F"
            ><div class='name'>设计模式</div><div class='badge'>(10)</div></a></li>
        
      </ul>
    </div>
  </section>


  

  
    
    
  

  <section class="widget tagcloud shadow floatable desktop">
    
  <header>
    
      <a href='/tags/'><i class="fas fa-tags fa-fw" aria-hidden="true"></i><span class='name'>热门标签</span></a>
    
  </header>


    <div class='content'>
      <a href="/tags/Beautifulsoup/" style="font-size: 17.33px; color: #828282">Beautifulsoup</a> <a href="/tags/Data-Preprocessing/" style="font-size: 14px; color: #999">Data Preprocessing</a> <a href="/tags/DecisionTree/" style="font-size: 14px; color: #999">DecisionTree</a> <a href="/tags/Feature-Engineering/" style="font-size: 14px; color: #999">Feature Engineering</a> <a href="/tags/Filter/" style="font-size: 14px; color: #999">Filter</a> <a href="/tags/IO%E6%B5%81/" style="font-size: 14px; color: #999">IO流</a> <a href="/tags/JDBC/" style="font-size: 17.33px; color: #828282">JDBC</a> <a href="/tags/JQuery/" style="font-size: 14px; color: #999">JQuery</a> <a href="/tags/Java/" style="font-size: 20.67px; color: #6c6c6c">Java</a> <a href="/tags/JavaScript/" style="font-size: 14px; color: #999">JavaScript</a> <a href="/tags/JavaWeb/" style="font-size: 17.33px; color: #828282">JavaWeb</a> <a href="/tags/Kaggle/" style="font-size: 14px; color: #999">Kaggle</a> <a href="/tags/Linux/" style="font-size: 17.33px; color: #828282">Linux</a> <a href="/tags/MBG/" style="font-size: 14px; color: #999">MBG</a> <a href="/tags/MVC/" style="font-size: 14px; color: #999">MVC</a> <a href="/tags/Mapper/" style="font-size: 14px; color: #999">Mapper</a> <a href="/tags/Mongodb/" style="font-size: 14px; color: #999">Mongodb</a> <a href="/tags/MySQL/" style="font-size: 20.67px; color: #6c6c6c">MySQL</a> <a href="/tags/Mybatis/" style="font-size: 20.67px; color: #6c6c6c">Mybatis</a> <a href="/tags/NIO/" style="font-size: 14px; color: #999">NIO</a> <a href="/tags/Nginx/" style="font-size: 14px; color: #999">Nginx</a> <a href="/tags/Python/" style="font-size: 14px; color: #999">Python</a> <a href="/tags/Request/" style="font-size: 17.33px; color: #828282">Request</a> <a href="/tags/Servlet/" style="font-size: 20.67px; color: #6c6c6c">Servlet</a> <a href="/tags/Spring/" style="font-size: 17.33px; color: #828282">Spring</a> <a href="/tags/SpringMVC/" style="font-size: 17.33px; color: #828282">SpringMVC</a> <a href="/tags/Springboot-starter/" style="font-size: 14px; color: #999">Springboot-starter</a> <a href="/tags/ThreadLocal/" style="font-size: 14px; color: #999">ThreadLocal</a> <a href="/tags/VMware/" style="font-size: 14px; color: #999">VMware</a> <a href="/tags/conda/" style="font-size: 14px; color: #999">conda</a> <a href="/tags/git/" style="font-size: 14px; color: #999">git</a> <a href="/tags/hexo/" style="font-size: 14px; color: #999">hexo</a> <a href="/tags/redis/" style="font-size: 14px; color: #999">redis</a> <a href="/tags/servlet/" style="font-size: 14px; color: #999">servlet</a> <a href="/tags/sklearn/" style="font-size: 17.33px; color: #828282">sklearn</a> <a href="/tags/ssm/" style="font-size: 14px; color: #999">ssm</a> <a href="/tags/%E4%BE%9D%E8%B5%96%E5%80%92%E7%BD%AE%E5%8E%9F%E5%88%99/" style="font-size: 14px; color: #999">依赖倒置原则</a> <a href="/tags/%E5%89%8D%E7%BC%80%E6%A0%91/" style="font-size: 14px; color: #999">前缀树</a> <a href="/tags/%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/" style="font-size: 14px; color: #999">动态代理</a> <a href="/tags/%E5%8D%95%E4%B8%80%E8%81%8C%E8%B4%A3%E5%8E%9F%E5%88%99/" style="font-size: 14px; color: #999">单一职责原则</a> <a href="/tags/%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F/" style="font-size: 14px; color: #999">单例模式</a> <a href="/tags/%E5%8E%9F%E5%9E%8B%E6%A8%A1%E5%BC%8F/" style="font-size: 14px; color: #999">原型模式</a> <a href="/tags/%E5%8F%8D%E5%B0%84/" style="font-size: 17.33px; color: #828282">反射</a> <a href="/tags/%E5%A0%86%E6%8E%92%E5%BA%8F/" style="font-size: 14px; color: #999">堆排序</a> <a href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" style="font-size: 14px; color: #999">多线程</a> <a href="/tags/%E5%B7%A5%E5%8E%82%E6%A8%A1%E5%BC%8F/" style="font-size: 14px; color: #999">工厂模式</a> <a href="/tags/%E5%B9%B6%E6%9F%A5%E9%9B%86/" style="font-size: 14px; color: #999">并查集</a> <a href="/tags/%E5%BB%BA%E9%80%A0%E8%80%85%E6%A8%A1%E5%BC%8F/" style="font-size: 14px; color: #999">建造者模式</a> <a href="/tags/%E5%BC%80%E9%97%AD%E5%8E%9F%E5%88%99/" style="font-size: 14px; color: #999">开闭原则</a> <a href="/tags/%E6%8E%A5%E5%8F%A3%E9%9A%94%E7%A6%BB%E5%8E%9F%E5%88%99/" style="font-size: 14px; color: #999">接口隔离原则</a> <a href="/tags/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/" style="font-size: 17.33px; color: #828282">正则表达式</a> <a href="/tags/%E6%BA%90%E7%A0%81/" style="font-size: 17.33px; color: #828282">源码</a> <a href="/tags/%E7%88%AC%E8%99%AB/" style="font-size: 17.33px; color: #828282">爬虫</a> <a href="/tags/%E7%BB%84%E5%90%88%E4%BC%98%E4%BA%8E%E7%BB%A7%E6%89%BF%E5%8E%9F%E5%88%99/" style="font-size: 14px; color: #999">组合优于继承原则</a> <a href="/tags/%E8%A1%A8%E5%8D%95%E9%AA%8C%E8%AF%81/" style="font-size: 14px; color: #999">表单验证</a> <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size: 24px; color: #555">设计模式</a> <a href="/tags/%E9%80%82%E9%85%8D%E5%99%A8%E6%A8%A1%E5%BC%8F/" style="font-size: 14px; color: #999">适配器模式</a>
    </div>
  </section>


  

  
    
    


  <section class="widget toc-wrapper shadow floatable desktop mobile">
    
  <header>
    
      <i class="fas fa-list fa-fw" aria-hidden="true"></i><span class='name'>本文目录</span>
    
  </header>


    <div class='content'>
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#0、基本介绍"><span class="toc-text">0、基本介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#一、IOC-–-控制反转"><span class="toc-text">一、IOC – 控制反转</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-ApplicationContext的三个常用实现类"><span class="toc-text">1.1  ApplicationContext的三个常用实现类:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-核心容器的两个接口引发出的问题"><span class="toc-text">1.2 核心容器的两个接口引发出的问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-Bean对象的细节"><span class="toc-text">1.3 Bean对象的细节</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-Spring的依赖注入"><span class="toc-text">1.4 Spring的依赖注入</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-4-1-构造函数注入（构造器注入）"><span class="toc-text">1.4.1 构造函数注入（构造器注入）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-4-2-set方法注入-–-适用于存在空参的构造方法-更常用的set方法注入"><span class="toc-text">1.4.2 set方法注入 – 适用于存在空参的构造方法(更常用的set方法注入)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-4-3-复杂类型的注入-集合类型的注入"><span class="toc-text">1.4.3 复杂类型的注入&#x2F;集合类型的注入</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#二、基于注解的方式-–-IOC"><span class="toc-text">二、基于注解的方式 – IOC</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-实例：简单的数据库增删改查"><span class="toc-text">2.1 实例：简单的数据库增删改查</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-使用注解不带有xml配置文件的使用-纯注解"><span class="toc-text">2.2 使用注解不带有xml配置文件的使用(纯注解)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-spring整合junit问题"><span class="toc-text">2.3 spring整合junit问题</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#三、AOP-–-导读"><span class="toc-text">三、AOP – 导读</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-案例-transfer-银行转账案例"><span class="toc-text">3.1 案例-transfer(银行转账案例)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#四、Spring-AOP"><span class="toc-text">四、Spring AOP</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-AOP基本介绍"><span class="toc-text">4.1 AOP基本介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-Spring中的AOP介绍"><span class="toc-text">4.2 Spring中的AOP介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-1-AOP相关术语介绍及使用介绍"><span class="toc-text">4.2.1 AOP相关术语介绍及使用介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-2-四种常用通知类型"><span class="toc-text">4.1.2 四种常用通知类型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-3-环绕通知"><span class="toc-text">4.1.3 环绕通知</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#4-1-3-1-问题"><span class="toc-text">4.1.3.1 问题</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-1-3-2-分析"><span class="toc-text">4.1.3.2 分析</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-1-3-3-解决"><span class="toc-text">4.1.3.3 解决</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-2-基于注解的AOP配置"><span class="toc-text">4.2.2 基于注解的AOP配置</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#五、Spring事务相关"><span class="toc-text">五、Spring事务相关</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-Spring中JdbcTemplate-介绍"><span class="toc-text">5.1 Spring中JdbcTemplate 介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-1-1-Spring-JdbcTemplate的内置数据源"><span class="toc-text">5.1.1 Spring JdbcTemplate的内置数据源</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-1-2-JdbcTemplate的使用-–-CRUD"><span class="toc-text">5.1.2 JdbcTemplate的使用 – CRUD</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-1-3-JdbcDaoSupport的使用"><span class="toc-text">5.1.3 JdbcDaoSupport的使用</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-Spring中事务控制的API"><span class="toc-text">5.2 Spring中事务控制的API</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-1-Spring事务控制"><span class="toc-text">5.2.1 Spring事务控制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-2-Spring中事务控制的API介绍"><span class="toc-text">5.2.2 Spring中事务控制的API介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-3-事务的隔离级别"><span class="toc-text">5.2.3 事务的隔离级别</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-4-事务的隔离级别"><span class="toc-text">5.2.4 事务的隔离级别</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-5-TransactionStatus接口"><span class="toc-text">5.2.5 TransactionStatus接口</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-Spring中基于XML的声明式事务控制配置步骤"><span class="toc-text">5.3 Spring中基于XML的声明式事务控制配置步骤</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-4-Spring中基于注解的声明式事务控制配置步骤"><span class="toc-text">5.4 Spring中基于注解的声明式事务控制配置步骤</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-4-1-基于纯注解的声明式事务控制"><span class="toc-text">5.4.1 基于纯注解的声明式事务控制</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-5-Spring编程式事务控制"><span class="toc-text">5.5 Spring编程式事务控制</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#六、Spring整合JavaWeb"><span class="toc-text">六、Spring整合JavaWeb</span></a></li></ol>
    </div>
  </section>


  


</aside>


  
  <footer class="clearfix">
    <br><br>
    
      
        <div class="aplayer-container">
          


        </div>
      
    
      
        <br>
        <div class="social-wrapper">
          
            
              <a href="https://github.com/Chemlez"
                class="social fab fa-github flat-btn"
                target="_blank"
                rel="external nofollow noopener noreferrer">
              </a>
            
          
            
              <a href="https://weibo.com/u/5653780011?nick=Sane_z&amp;is_all=1"
                class="social fab fa-weibo flat-btn"
                target="_blank"
                rel="external nofollow noopener noreferrer">
              </a>
            
          
            
              <a href="mailto:liz_1106@163.com"
                class="social fas fa-envelope flat-btn"
                target="_blank"
                rel="external nofollow noopener noreferrer">
              </a>
            
          
        </div>
      
    
      
        <div class='copyright'>
        <p><a href="https://chemlez.cn" target="_blank" rel="noopener">Copyright © 2019-2021 Chemlez</a></p>

        </div>
      
    
  </footer>

<script>setLoadingBarProgress(80);</script>


      <script>setLoadingBarProgress(60);</script>
    </div>
    <a class="s-top fas fa-arrow-up fa-fw" href='javascript:void(0)'></a>
  </div>
  
<script src="https://cdn.jsdelivr.net/npm/jquery@3.4/dist/jquery.min.js"></script>


  <script>
    
    var SEARCH_SERVICE = "hexo" || "hexo";
    var ROOT = "/" || "/";
    if (!ROOT.endsWith('/')) ROOT += '/';
  </script>


  <script async src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-volantis@2/js/instant_page.js" type="module" defer integrity="sha384-OeDn4XE77tdHo8pGtE1apMPmAipjoxUQ++eeJa6EtJCfHlvijigWiJpD7VDPWXV1"></script>



  
<script src="https://cdn.jsdelivr.net/npm/node-waves@0.7.6/dist/waves.min.js"></script>

  <script type="text/javascript">
    $(function() {
      Waves.attach('.flat-btn', ['waves-button']);
      Waves.attach('.float-btn', ['waves-button', 'waves-float']);
      Waves.attach('.float-btn-light', ['waves-button', 'waves-float', 'waves-light']);
      Waves.attach('.flat-box', ['waves-block']);
      Waves.attach('.float-box', ['waves-block', 'waves-float']);
      Waves.attach('.waves-image');
      Waves.init();
    });
  </script>


  <script async src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-busuanzi@2.3/js/busuanzi.pure.mini.js"></script>



  
  
  
    
<script src="https://cdn.jsdelivr.net/npm/jquery-backstretch@2.1.18/jquery.backstretch.min.js"></script>

    <script type="text/javascript">
      $(function(){
        var imgs=["https://cdn.jsdelivr.net/gh/xaoxuu/cdn-wallpaper/abstract/41F215B9-261F-48B4-80B5-4E86E165259E.jpeg"];
        if ('true' == 'true') {
          function shuffle(arr){
            /*From countercurrent-time*/
            var n = arr.length;
            while(n--) {
              var index = Math.floor(Math.random() * n);
              var temp = arr[index];
              arr[index] = arr[n];
              arr[n] = temp;
            }
          }
          shuffle(imgs);
        }
        if ('.cover') {
          $('.cover').backstretch(
            imgs,
          {
            duration: "20000",
            fade: "1500"
          });
        } else {
          $.backstretch(
            imgs,
          {
            duration: "20000",
            fade: "1500"
          });
        }
      });
    </script>
  










  
    
<script src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-volantis@2.0/js/valine.js"></script>

  
  <script>
  var GUEST_INFO = ['nick','mail','link'];
  var guest_info = 'nick,mail,link'.split(',').filter(function(item){
    return GUEST_INFO.indexOf(item) > -1
  });
  var notify = 'true' == true;
  var verify = 'true' == true;
  var valine = new Valine();
  valine.init({
    el: '#valine_container',
    notify: notify,
    verify: verify,
    guest_info: guest_info,
    
    appId: "YSitK1ig1lRcy3jvrtTzT6fb-MdYXbMMI",
    appKey: "e7hFf2zqvyWgNmDsClWcM7W3",
    placeholder: "快来评论吧~",
    pageSize:'10',
    avatar:'wavatar',
    lang:'zh-cn',
    visitor: 'false',
    highlight:'true'
  })
  </script>



  
<script src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-volantis@2.1.5/js/app.js"></script>



  
<script src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-volantis@2.1/js/search.js"></script>



  
<script src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-volantis@2/js/comment_typing.js"></script>



<!-- 复制 -->

  <script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
<script>
  !function (e, t, a) {
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="fas fa-copy"></i><span>COPY</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });
      clipboard.on('success', function(e) {
        let $btn = $(e.trigger);
        $btn.addClass('copyed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('fa-copy');
        $icon.addClass('fa-clipboard-check');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPYED';
      });
      clipboard.on('error', function(e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass('copy-failed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('fa-copy');
        $icon.addClass('fa-exclamation-triangle');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPY FAILED';
      });
    }
    initCopyCode();
  }(window, document);
</script>




<!-- fancybox -->

  <script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>
<script>
  let LAZY_LOAD_IMAGE = "[object Object]";
  $(".article-entry").find("fancybox").find("img").each(function () {
      var element = document.createElement("a");
      $(element).attr("data-fancybox", "gallery");
      $(element).attr("href", $(this).attr("src"));
      /* 图片采用懒加载处理时,
       * 一般图片标签内会有个属性名来存放图片的真实地址，比如 data-original,
       * 那么此处将原本的属性名src替换为对应属性名data-original,
       * 修改如下
       */
       if (LAZY_LOAD_IMAGE) {
         $(element).attr("href", $(this).attr("data-original"));
       }
      $(this).wrap(element);
  });
</script>






  <script>setLoadingBarProgress(100);</script>
<script>!function(e){var c=Array.prototype.slice.call(document.querySelectorAll("img[data-original]"));function i(){for(var r=0;r<c.length;r++)t=c[r],0<=(n=t.getBoundingClientRect()).bottom&&0<=n.left&&n.top<=(e.innerHeight||document.documentElement.clientHeight)&&function(){var t,n,e,i,o=c[r];t=o,n=function(){c=c.filter(function(t){return o!==t})},e=new Image,i=t.getAttribute("data-original"),e.onload=function(){t.src=i,n&&n()},e.src=i}();var t,n}i(),e.addEventListener("scroll",function(){var t,n;t=i,n=e,clearTimeout(t.tId),t.tId=setTimeout(function(){t.call(n)},500)})}(this);</script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})});</script></body>
</html>
